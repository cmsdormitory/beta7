<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>明馬二樓積分兌換系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2575fc;
            --secondary: #6a11cb;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --light: #f8f9fa;
            --dark: #343a40;
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --radius: 16px;
        }

        .theme-dark {
            --glass-bg: rgba(30, 30, 40, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --text-color: #f0f0f0;
            --card-bg: rgba(40, 40, 50, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            background: linear-gradient(135deg, #a6d1ff 0%, #c2e9fb 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            color: #333;
        }
        
        body.theme-dark {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--text-color);
        }
        
        /* 加载动画 */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        
        .loader-content {
            text-align: center;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(37, 117, 252, 0.3);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 落叶动画效果 */
        .leaf {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ffd700;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            opacity: 0.7;
            animation: falling linear infinite;
            z-index: 0;
        }
        
        @keyframes falling {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            90% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        /* 玻璃水滴型卡片设计 */
        .card {
            background: var(--glass-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .card {
            background: var(--card-bg);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, rgba(37, 117, 252, 0.5) 0%, rgba(106, 17, 203, 0.5) 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card:hover::before {
            transform: scaleX(1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .card-header i {
            font-size: 24px;
            margin-right: 15px;
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        
        .card:hover .card-header i {
            transform: scale(1.1);
        }
        
        .card-header h2 {
            color: var(--dark);
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .theme-dark .card-header h2 {
            color: var(--text-color);
        }
        
        .login-section {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .login-card {
            flex: 1;
            min-width: 300px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .theme-dark .form-group label {
            color: #ccc;
        }
        
        /* 玻璃水滴型输入框 */
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            color: inherit;
        }
        
        .theme-dark .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
        }
        
        .form-control:focus {
            border-color: rgba(37, 117, 252, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .theme-dark .form-control:focus {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 层次感按钮设计 */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(37, 117, 252, 0.3);
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:hover::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #1a68e8 0%, #5a0fb5 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 117, 252, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(37, 117, 252, 0.4);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60 0%, #219955 100%);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d35400 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d35400 0%, #ba4a00 100%);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d 0%, #6c7a7d 100%);
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
        }
        
        .barcode-scan {
            text-align: center;
            padding: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .barcode-scan:hover {
            border-color: rgba(37, 117, 252, 0.7);
            background: rgba(37, 117, 252, 0.1);
        }
        
        .barcode-scan i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        
        .barcode-scan:hover i {
            transform: scale(1.1);
        }
        
        .barcode-scan p {
            color: #666;
            font-size: 16px;
        }
        
        .theme-dark .barcode-scan p {
            color: #ccc;
        }
        
        .dashboard {
            display: none;
        }
        
        .user-info {
            background: linear-gradient(135deg, rgba(37, 117, 252, 0.7) 0%, rgba(106, 17, 203, 0.7) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .user-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .points {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            color: var(--dark);
        }
        
        .theme-dark .tab {
            color: var(--text-color);
        }
        
        .tab.active {
            border-bottom: 3px solid rgba(37, 117, 252, 0.7);
            color: var(--primary);
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .prizes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .prize-card {
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .prize-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .prize-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .theme-dark .prize-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .prize-image {
            width: 100%;
            height: 150px;
            background: rgba(245, 245, 245, 0.5);
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        
        .theme-dark .prize-image {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .prize-card:hover .prize-image {
            transform: scale(1.05);
        }
        
        .prize-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .prize-points {
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .admin-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .admin-controls .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .users-table, .history-table, .prizes-table, .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .users-table th, .users-table td,
        .history-table th, .history-table td,
        .prizes-table th, .prizes-table td,
        .leaderboard-table th, .leaderboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            transition: background-color 0.2s;
        }
        
        .users-table th, .history-table th, .prizes-table th, .leaderboard-table th {
            background: rgba(248, 249, 250, 0.5);
            font-weight: 600;
            color: #555;
        }
        
        .theme-dark .users-table th, 
        .theme-dark .history-table th, 
        .theme-dark .prizes-table th, 
        .theme-dark .leaderboard-table th {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }
        
        .users-table tr:hover, .history-table tr:hover, .prizes-table tr:hover, .leaderboard-table tr:hover {
            background: rgba(248, 249, 250, 0.3);
        }
        
        .theme-dark .users-table tr:hover, 
        .theme-dark .history-table tr:hover, 
        .theme-dark .prizes-table tr:hover, 
        .theme-dark .leaderboard-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .action-btn {
            padding: 6px 12px;
            margin-right: 5px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .logout-btn {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .logout-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        /* 更醒目的成就解锁通知 */
        .achievement-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px 40px;
            background: linear-gradient(135deg, #ffd700 0%, #ff9500 100%);
            color: #000;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), 0 0 50px rgba(255, 215, 0, 0.5);
            display: none;
            z-index: 9999;
            animation: achievementPopup 0.6s ease-out, achievementFloat 3s ease-in-out 0.6s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 3px solid #fff;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .achievement-notification.unlocked {
            display: block;
        }
        
        .achievement-notification h3 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #000;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .achievement-notification p {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #333;
        }
        
        .achievement-notification .reward {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2575fc;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            margin-top: 10px;
        }
        
        .achievement-notification-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #2575fc;
            animation: achievementIconSpin 1s ease-in-out 1.5s;
        }
        
        /* 成就通知关闭按钮 */
        .achievement-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #000;
            transition: color 0.3s;
        }
        
        .achievement-close-btn:hover {
            color: #ff0000;
        }
        
        @keyframes achievementPopup {
            0% {
                transform: translate(-50%, -50%) scale(0.1);
                opacity: 0;
            }
            70% {
                transform: translate(-50%, -50%) scale(1.05);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes achievementFloat {
            0% {
                transform: translate(-50%, -50%);
            }
            25% {
                transform: translate(-50%, -55%);
            }
            50% {
                transform: translate(-50%, -50%);
            }
            75% {
                transform: translate(-50%, -52%);
            }
            100% {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }
        
        @keyframes achievementIconSpin {
            0% {
                transform: rotate(0deg) scale(1);
            }
            50% {
                transform: rotate(180deg) scale(1.3);
            }
            100% {
                transform: rotate(360deg) scale(1);
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            animation: slideInRight 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--glass-bg);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .modal-content {
            background: var(--card-bg);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .modal-header h3 {
            color: var(--dark);
            font-size: 1.5rem;
        }
        
        .theme-dark .modal-header h3 {
            color: var(--text-color);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--dark);
        }
        
        .theme-dark .close-btn:hover {
            color: var(--text-color);
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            transition: background-color 0.2s;
            border-radius: 10px;
            margin-bottom: 5px;
        }
        
        .history-item:hover {
            background-color: rgba(248, 249, 250, 0.3);
        }
        
        .theme-dark .history-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-points {
            font-weight: bold;
        }
        
        .points-positive {
            color: var(--success);
        }
        
        .points-negative {
            color: var(--danger);
        }
        
        .barcode-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 12px;
        }
        
        .theme-dark .barcode-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .barcode-container canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            background: white;
        }
        
        .barcode-placeholder {
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .theme-dark .barcode-placeholder {
            color: #ccc;
        }
        
        .scan-area {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #scanner-container {
            width: 100%;
            height: 300px;
            background: rgba(245, 245, 245, 0.5);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .theme-dark #scanner-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        
        .scan-line {
            width: 80%;
            height: 2px;
            background: var(--primary);
            position: relative;
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: -50%; }
            100% { top: 150%; }
        }
        
        .scan-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .user-barcode {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
        }
        
        .login-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* 玻璃水滴型登录选项按钮 */
        .login-option-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .login-option-btn {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .login-option-btn.active {
            background: rgba(37, 117, 252, 0.3);
            color: white;
            border-color: rgba(37, 117, 252, 0.5);
        }
        
        .login-option-btn:hover {
            background: rgba(37, 117, 252, 0.2);
            transform: translateY(-2px);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
        }
        
        .data-management {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .data-management .btn {
            flex: 1;
            min-width: 150px;
        }
        
        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .stat-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .theme-dark .stat-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .theme-dark .stat-label {
            color: #ccc;
        }
        
        /* 优化选项框样式 - 更圆滑、半透明 */
        .reason-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            color: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }
        
        .theme-dark .reason-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
        
        .reason-select:focus {
            border-color: rgba(37, 117, 252, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .theme-dark .reason-select:focus {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .reason-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: inherit;
        }
        
        .theme-dark .reason-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-tier {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .tier-king {
            background-color: #ffd900;
            color: #000;
        }
        
        .tier-diamond {
            background-color: #9035F8;
            color: white;
        }
        
        .tier-platinum {
            background-color: #75c8ff;
            color: #000;
        }
        
        .tier-gold {
            background-color: #ff8904;
            color: white;
        }
        
        .tier-silver {
            background-color: #5fecfc;
            color: #000;
        }
        
        .tier-bronze {
            background-color: brown;
            color: white;
        }
        
        /* 排行榜样式 - 前三名更醒目 */
        .leaderboard-container {
            display: flex;
            gap: 25px;
            margin-top: 20px;
        }
        
        .leaderboard-table-container {
            flex: 2;
        }
        
        .leaderboard-table tr.top-three {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
            border-left: 4px solid #ffd700;
        }
        
        .leaderboard-table tr:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.15) 100%);
            border-left: 4px solid #ffd700;
            font-weight: bold;
        }
        
        .leaderboard-table tr:nth-child(2) {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.3) 0%, rgba(192, 192, 192, 0.15) 100%);
            border-left: 4px solid #c0c0c0;
            font-weight: bold;
        }
        
        .leaderboard-table tr:nth-child(3) {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.3) 0%, rgba(205, 127, 50, 0.15) 100%);
            border-left: 4px solid #cd7f32;
            font-weight: bold;
        }
        
        .theme-dark .leaderboard-table tr:nth-child(1),
        .theme-dark .leaderboard-table tr:nth-child(2),
        .theme-dark .leaderboard-table tr:nth-child(3) {
            color: white;
        }
        
        .pie-chart-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .pie-chart-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .pie-chart {
            width: 250px;
            height: 250px;
            position: relative;
        }
        
        .pie-chart canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* 成就系统样式 */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .achievement-card {
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .achievement-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .achievement-card.locked {
            opacity: 0.6;
            filter: grayscale(50%);
        }
        
        .achievement-card.unlocked {
            border-color: var(--success);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
        }
        
        .achievement-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .achievement-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 32px;
            color: white;
            transition: transform 0.3s ease;
        }
        
        .achievement-card:hover .achievement-icon {
            transform: scale(1.1) rotate(10deg);
        }
        
        .achievement-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .theme-dark .achievement-name {
            color: var(--text-color);
        }
        
        .achievement-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .theme-dark .achievement-description {
            color: #ccc;
        }
        
        .achievement-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .achievement-unlocked {
            background: var(--success);
            color: white;
        }
        
        .achievement-locked {
            background: #95a5a6;
            color: white;
        }
        
        .achievement-progress {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .achievement-progress-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        
        .theme-dark .achievement-progress-text {
            color: #ccc;
        }
        
        .achievement-reward {
            margin-top: 10px;
            color: var(--warning);
            font-weight: 600;
        }
        
        /* 新增：系统公告样式 */
        .announcement-section {
            margin-bottom: 25px;
        }
        
        .announcement-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 149, 0, 0.2) 100%);
            border-left: 5px solid var(--warning);
        }
        
        .theme-dark .announcement-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 149, 0, 0.1) 100%);
        }
        
        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .announcement-content {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .announcement-content p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .announcement-date {
            font-size: 0.9rem;
            color: #666;
            text-align: right;
        }
        
        .theme-dark .announcement-date {
            color: #ccc;
        }
        
        /* 新增：兑换确认页面样式 */
        .redeem-confirm-content {
            text-align: center;
        }
        
        .redeem-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .redeem-icon {
            font-size: 64px;
            color: var(--primary);
        }
        
        .redeem-info h4 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .redeem-info p {
            color: #666;
            font-size: 1.2rem;
        }
        
        .theme-dark .redeem-info p {
            color: #ccc;
        }
        
        .user-balance-check {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .balance-after {
            font-weight: bold;
            font-size: 1.2rem;
            margin-top: 5px;
        }
        
        .balance-positive {
            color: var(--success);
        }
        
        .balance-negative {
            color: var(--danger);
        }
        
        .confirm-buttons {
            display: flex;
            gap: 15px;
        }
        
        /* 新增：详细统计报告样式 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .stats-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stats-card h4 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
            color: var(--primary);
        }
        
        .stats-list {
            list-style-type: none;
        }
        
        .stats-list li {
            padding: 8px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
        }
        
        .stats-list li:last-child {
            border-bottom: none;
        }
        
        .stats-value {
            font-weight: bold;
            color: var(--primary);
        }
        
        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 15px;
        }
        
        /* 新增：用户等级系统样式 */
        .level-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 8px;
            font-size: 0.8rem;
        }
        
        .level-1 { background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%); color: white; }
        .level-2 { background: linear-gradient(135deg, #c0c0c0 0%, #a0a0a0 100%); color: white; }
        .level-3 { background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%); color: black; }
        .level-4 { background: linear-gradient(135deg, #e5e4e2 0%, #c0c0c0 100%); color: black; }
        .level-5 { background: linear-gradient(135deg, #b9f2ff 0%, #87ceeb 100%); color: black; }
        .level-6 { background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%); color: black; }
        .level-7 { background: linear-gradient(135deg, #9035F8 0%, #6a0dad 100%); color: white; }
        .level-8 { background: linear-gradient(135deg, #ff0000 0%, #8b0000 100%); color: white; }
        .level-9 { background: linear-gradient(135deg, #000000 0%, #333333 100%); color: white; }
        .level-10 { background: linear-gradient(135deg, #ffd700, #ff9500, #ff0000); color: black; }
        
        .level-progress {
            margin-top: 10px;
        }
        
        .level-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .level-progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .level-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        /* 新增：系统参数配置样式 */
        .config-section {
            margin-bottom: 25px;
        }
        
        .config-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }
        
        .theme-dark .config-item {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .config-label {
            flex: 1;
        }
        
        .config-value {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .config-input {
            width: 100px;
        }
        
        .config-description {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .theme-dark .config-description {
            color: #ccc;
        }
        
        /* 新增：通知偏好设置样式 */
        .notification-preferences {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .preference-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }
        
        .theme-dark .preference-item {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .preference-info h5 {
            margin-bottom: 5px;
        }
        
        .preference-info p {
            font-size: 0.9rem;
            color: #666;
        }
        
        .theme-dark .preference-info p {
            color: #ccc;
        }
        
        /* 切换开关样式 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* 新增：消息欄样式 */
        .messages-container {
            margin-top: 20px;
        }
        
        .message-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .message-filter-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .message-filter-btn {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .message-filter-btn.active {
            background: rgba(37, 117, 252, 0.3);
            color: white;
            border-color: rgba(37, 117, 252, 0.5);
        }
        
        .message-filter-btn:hover {
            background: rgba(37, 117, 252, 0.2);
            transform: translateY(-2px);
        }
        
        .message-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message-item {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 4px solid #3498db;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .message-item {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .message-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .message-item.unread {
            border-left: 4px solid var(--primary);
            background: rgba(37, 117, 252, 0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .message-sender {
            font-weight: bold;
            color: var(--primary);
        }
        
        .message-date {
            font-size: 0.8rem;
            color: #666;
        }
        
        .theme-dark .message-date {
            color: #ccc;
        }
        
        .message-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .message-preview {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .theme-dark .message-preview {
            color: #ccc;
        }
        
        .message-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .type-announcement { background-color: #f39c12; color: white; }
        .type-feedback { background-color: #3498db; color: white; }
        .type-mail { background-color: #2ecc71; color: white; }
        .type-system { background-color: #9b59b6; color: white; }
        
        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* 新增：邮件对话样式 */
        .message-thread {
            margin-top: 20px;
            border-top: 1px solid var(--glass-border);
            padding-top: 20px;
        }
        
        .thread-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }
        
        .theme-dark .thread-item {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .thread-item.sent {
            border-left: 4px solid #2ecc71;
            margin-left: 20px;
        }
        
        .thread-item.received {
            border-left: 4px solid #3498db;
            margin-right: 20px;
        }
        
        .thread-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .thread-sender {
            font-weight: bold;
        }
        
        .thread-date {
            color: #666;
        }
        
        .theme-dark .thread-date {
            color: #ccc;
        }
        
        .thread-content {
            line-height: 1.5;
        }
        
        /* 新增：发送消息样式 */
        .new-message-form {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .new-message-form {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .message-recipient-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            color: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }
        
        .theme-dark .message-recipient-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
        
        .message-recipient-select:focus {
            border-color: rgba(37, 117, 252, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .theme-dark .message-recipient-select:focus {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 新增的颜色设定 */
        #activeUsers,
        #activeUsers + .stat-label {
            color: #ffd900; /* 王者用户 */
        }

        #activeUser4,
        #activeUser4 + .stat-label {
            color: #9035F8; /* 钻石用户 */
        }

        #activeUser3,
        #activeUser3 + .stat-label {
            color: #75c8ff; /* 铂金用户 */
        }

        #activeUser2,
        #activeUser2 + .stat-label {
            color: #ff8904; /* 黄金用户 */
        }

        #activeUser1,
        #activeUser1 + .stat-label {
            color: #5fecfc; /* 白银用户 */
        }

        #activeUser0,
        #activeUser0 + .stat-label {
            color: brown; /* 青铜用户 */
        }
        
        /* 进度条样式 */
        .progress-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* 徽章样式 */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        @media (max-width: 768px) {
            .login-section {
                flex-direction: column;
            }
            
            .admin-controls {
                flex-direction: column;
            }
            
            .prizes-grid {
                grid-template-columns: 1fr;
            }
            
            .achievements-grid {
                grid-template-columns: 1fr;
            }
            
            .announcements-grid {
                grid-template-columns: 1fr;
            }
            
            .users-table, .history-table, .prizes-table, .leaderboard-table {
                display: block;
                overflow-x: auto;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .login-options {
                flex-direction: column;
            }
            
            .data-management {
                flex-direction: column;
            }
            
            .user-stats {
                grid-template-columns: 1fr;
            }
            
            .leaderboard-container {
                flex-direction: column;
            }
            
            .pie-chart {
                width: 200px;
                height: 200px;
            }
            
            .achievement-notification {
                padding: 20px 25px;
            }
            
            .achievement-notification h3 {
                font-size: 1.5rem;
            }
            
            .achievement-notification p {
                font-size: 1rem;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .confirm-buttons {
                flex-direction: column;
            }
            
            .redeem-item {
                flex-direction: column;
                gap: 10px;
            }
            
            .announcement-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .message-filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div class="loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <h3>加載中...</h3>
            <p>正在初始化系統</p>
        </div>
    </div>
    
    <!-- 成就解锁通知 -->
    <div class="achievement-notification" id="achievementNotification">
        <button class="achievement-close-btn" id="closeAchievementNotification">&times;</button>
        <div class="achievement-notification-icon">
            <i class="fas fa-trophy"></i>
        </div>
        <h3>成就解鎖！</h3>
        <p id="achievementNotificationName">成就名稱</p>
        <p id="achievementNotificationDesc">成就描述</p>
        <div class="reward" id="achievementNotificationReward">榮譽成就，無積分獎勵</div>
    </div>
    
    <!-- 兑换确认模态框 -->
    <div class="modal" id="redeemConfirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>確認兌換</h3>
                <button class="close-btn" id="closeRedeemModal">&times;</button>
            </div>
            <div class="redeem-confirm-content">
                <div class="redeem-item">
                    <div class="redeem-icon">
                        <i id="confirmPrizeIcon" class="fas fa-gift"></i>
                    </div>
                    <div class="redeem-info">
                        <h4 id="confirmPrizeName">奖品名称</h4>
                        <p>所需積分: <span id="confirmPrizePoints">0</span></p>
                    </div>
                </div>
                
                <div class="user-balance-check">
                    <p>當前積分: <span id="confirmUserCurrentPoints">0</span></p>
                    <p>兌換後積分: <span id="confirmUserAfterPoints" class="balance-after">0</span></p>
                </div>
                
                <p style="margin-bottom: 20px; color: #666;">確認要兌換此獎品嗎？此操作不可撤銷。</p>
                
                <div class="confirm-buttons">
                    <button class="btn btn-secondary" id="cancelRedeemBtn">取消</button>
                    <button class="btn btn-success" id="confirmRedeemBtn">確認兌換</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 落叶动画元素 -->
    <div id="leaves-container"></div>
    
    <div class="container">
        <div class="header">
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <h1>明馬二樓宿舍積分兌換系統</h1>
            <p>明愛馬鞍山中學二樓宿舍專用</p>
        </div>
        
        <!-- 系统公告区域 -->
        <div class="announcement-section" id="announcementSection" style="display: none;">
            <div class="card announcement-card">
                <div class="announcement-header">
                    <h3><i class="fas fa-bullhorn"></i> 系統公告</h3>
                    <button class="btn btn-secondary btn-sm" id="closeAnnouncementBtn" style="padding: 8px 15px;">關閉</button>
                </div>
                <div class="announcement-content" id="announcementContent">
                    <!-- 公告内容将通过JavaScript动态生成 -->
                </div>
                <div class="announcement-date" id="announcementDate"></div>
            </div>
        </div>
        
        <!-- 登陸區域 -->
        <div class="login-section" id="loginSection">
            <!-- 用戶登錄 -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user"></i>
                    <h2>用戶登錄</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="userCodeLoginBtn">用戶編號登陸</div>
                    <div class="login-option-btn" id="userBarcodeLoginBtn">QRcode登陸</div>
                </div>
                
                <div id="userCodeLoginForm">
                    <div class="form-group">
                        <label for="userIdInput">用戶編號</label>
                        <input type="text" id="userIdInput" class="form-control" placeholder="輸入用戶編號">
                    </div>
                    <button class="btn btn-block" id="userLoginBtn">用戶登錄</button>
                </div>
                
                <div id="userBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="userBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>點擊此處掃描QRcode</p>
                        <p class="small">並將QRcode對準攝像頭</p>
                    </div>
                </div>
                
                <div class="user-info" style="display: none;" id="userInfo">
                    <div>
                        <h3 id="userName">张三</h3>
                        <p>用户编号: <span id="userId">U1001</span></p>
                    </div>
                    <div class="points" id="userPoints">1500</div>
                </div>
            </div>
            
            <!-- 管理员登录 -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user-shield"></i>
                    <h2>管理员登录</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="adminCodeLoginBtn">管理員編號登陸</div>
                    <div class="login-option-btn" id="adminBarcodeLoginBtn">管理員QRcode登陸</div>
                </div>
                
                <div id="adminCodeLoginForm">
                    <div class="form-group">
                        <label for="adminId">管理員編號</label>
                        <input type="text" id="adminId" class="form-control" placeholder="輸入管理員編號">
                    </div>
                    
                    <div class="form-group">
                        <label for="adminPassword">管理員密碼</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="請輸入管理員密碼">
                    </div>
                    
                    <button class="btn btn-block" id="adminLoginBtn">管理員登陸</button>
                </div>
                
                <div id="adminBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="adminBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>點擊此處掃描QRcode</p>
                        <p class="small">並將QRcode對準攝像頭</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 用户仪表盘 -->
        <div class="dashboard card" id="userDashboard">
            <div class="card-header">
                <i class="fas fa-gift"></i>
                <h2>積分兌換中心</h2>
            </div>
            
            <div class="user-info">
                <div>
                    <h3 id="dashboardUserName">张三</h3>
                    <p>用戶編號: <span id="dashboardUserId">U1001</span></p>
                    <p>QRcode編碼: <span id="dashboardUserBarcode">BARCODE001</span></p>
                    <p>段位: <span id="dashboardUserTier">青銅</span></p>
                    <p>用戶等級: <span id="dashboardUserLevel" class="level-badge level-1">等級 1</span></p>
                    <p>成就稱號: <span id="dashboardUserAchievementTitle">無</span></p>
                </div>
                <div>
                    <div class="points" id="dashboardUserPoints">1500</div>
                    <div style="text-align: right;">累積積分: <span id="dashboardUserTotalPoints">2500</span></div>
                </div>
            </div>
            
            <!-- 用户等级进度 -->
            <div class="level-progress" id="userLevelProgress" style="display: none;">
                <div class="level-info">
                    <span>等級進度</span>
                    <span id="levelProgressText">0/250 積分</span>
                </div>
                <div class="level-progress-bar">
                    <div class="level-progress-fill" id="levelProgressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="user-barcode">
                <h4>我的QRcode</h4>
                <div id="userBarcodeDisplay"></div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="prizes">獎品兌換</div>
                <div class="tab" data-tab="history">積分歷史</div>
                <div class="tab" data-tab="leaderboard">排行榜</div>
                <div class="tab" data-tab="achievements">成就系統</div>
                <div class="tab" data-tab="messages">消息欄</div>
                <div class="tab" data-tab="notifications">通知設定</div>
            </div>
            
            <div class="tab-content active" id="prizes-tab">
                <h3 style="margin-bottom: 15px;">可用獎品</h3>
                <div class="prizes-grid" id="prizesGrid">
                    <!-- 奖品将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="history-tab">
                <h3 style="margin-bottom: 15px;">積分歷史紀錄</h3>
                <div id="userHistoryContent">
                    <!-- 用户积分历史将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="leaderboard-tab">
                <h3 style="margin-bottom: 15px;">歷史積分排行榜</h3>
                <div class="leaderboard-container">
                    <div class="leaderboard-table-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>用戶姓名</th>
                                    <th>用戶編號</th>
                                    <th>累積積分</th>
                                    <th>段位</th>
                                    <th>等級</th>
                                </tr>
                            </thead>
                            <tbody id="userLeaderboardBody">
                                <!-- 排行榜数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pie-chart-container">
                        <h4>段位分布</h4>
                        <div class="pie-chart">
                            <canvas id="tierPieChart"></canvas>
                        </div>
                        <div class="pie-legend" id="pieLegend">
                            <!-- 图例将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="achievements-tab">
                <h3 style="margin-bottom: 15px;">成就系統</h3>
                <div class="user-stats" style="margin-bottom: 25px;">
                    <div class="stat-card">
                        <div class="stat-value" id="achievementUnlocked">0</div>
                        <div class="stat-label">已解鎖成就</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="achievementTotal">0</div>
                        <div class="stat-label">總成就數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="achievementProgress">0%</div>
                        <div class="stat-label">成就進度</div>
                    </div>
                </div>
                <div class="achievements-grid" id="achievementsGrid">
                    <!-- 成就将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 消息欄 -->
            <div class="tab-content" id="messages-tab">
                <h3 style="margin-bottom: 15px;">消息欄</h3>
                <p style="margin-bottom: 20px; color: #666;">查看所有系統公告、反饋回覆和個人郵件</p>
                
                <div class="message-filters">
                    <button class="message-filter-btn active" data-type="all">全部消息</button>
                    <button class="message-filter-btn" data-type="announcement">系統公告</button>
                    <button class="message-filter-btn" data-type="feedback">反饋回覆</button>
                    <button class="message-filter-btn" data-type="mail">個人郵件</button>
                    <button class="message-filter-btn" data-type="unread">未讀消息</button>
                </div>
                
                <div class="messages-container">
                    <div class="message-list" id="messageList">
                        <!-- 消息列表将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <div class="new-message-form" id="newMessageForm" style="display: none;">
                    <h4 style="margin-bottom: 15px;">發送新消息</h4>
                    <div class="form-group">
                        <label for="messageRecipient">收件人</label>
                        <select id="messageRecipient" class="message-recipient-select">
                            <option value="">-- 選擇收件人 --</option>
                            <!-- 用户列表将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="messageSubject">消息標題</label>
                        <input type="text" id="messageSubject" class="form-control" placeholder="輸入消息標題">
                    </div>
                    
                    <div class="form-group">
                        <label for="messageContent">消息內容</label>
                        <textarea id="messageContent" class="form-control" rows="5" placeholder="輸入消息內容"></textarea>
                    </div>
                    
                    <button class="btn btn-success" id="sendMessageBtn">發送消息</button>
                    <button class="btn btn-secondary" id="cancelMessageBtn">取消</button>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" id="newMessageBtn"><i class="fas fa-plus"></i> 發送新消息</button>
                    <button class="btn btn-secondary" id="markAllAsReadBtn"><i class="fas fa-check-double"></i> 標記全部為已讀</button>
                </div>
            </div>
            
            <div class="tab-content" id="notifications-tab">
                <h3 style="margin-bottom: 15px;">通知偏好設定</h3>
                <p style="margin-bottom: 20px; color: #666;">設定您希望接收的通知類型</p>
                
                <div class="notification-preferences" id="notificationPreferences">
                    <!-- 通知偏好设置将通过JavaScript动态生成 -->
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn" id="saveNotificationPrefsBtn">保存設定</button>
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="userLogoutBtn">退出登陸</button>
        </div>
        
        <!-- 管理员仪表盘 -->
        <div class="dashboard card" id="adminDashboard">
            <div class="card-header">
                <i class="fas fa-cogs"></i>
                <h2>積分管理系統</h2>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="users">用戶管理</div>
                <div class="tab" data-tab="prizes-admin">獎品管理</div>
                <div class="tab" data-tab="history-admin">積分歷史</div>
                <div class="tab" data-tab="leaderboard-admin">排行榜</div>
                <div class="tab" data-tab="stats-admin">統計報告</div>
                <div class="tab" data-tab="announcements-admin">系統公告</div>
                <div class="tab" data-tab="messages-admin">消息管理</div>
                <div class="tab" data-tab="config-admin">系統參數</div>
                <div class="tab" data-tab="system-admin">系統管理</div>
            </div>
            
            <div class="tab-content active" id="users-tab">
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">總用戶數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalPoints">0</div>
                        <div class="stat-label">總積分</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">👑👑👑王者用戶🏅️🏅️🏅️</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser4">0</div>
                        <div class="stat-label">💎鑽石用戶💎</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser3">0</div>
                        <div class="stat-label">💍鉑金用戶💍</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser2">0</div>
                        <div class="stat-label">✨黃金用戶✨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser1">0</div>
                        <div class="stat-label">🥈白銀用戶🥈</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser0">0</div>
                        <div class="stat-label">.🔥青銅用戶🔥.</div>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchUser" class="form-control" placeholder="輸入用戶編號·姓名或QRcode編碼">
                    <button class="btn" id="searchUserBtn">搜索</button>
                    <button class="btn btn-secondary" id="clearSearchBtn">清除</button>
                </div>
                
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="pointsChange">積分變更</label>
                        <input type="number" id="pointsChange" class="form-control" placeholder="輸入積分變更值">
                    </div>
                    <div class="form-group">
                        <label for="pointsReason">變更原因</label>
                        <select id="pointsReason" class="reason-select">
                            <option value="">-- 選擇原因 --</option>
                            <option value="任務獎勵">任務獎勵</option>
                            <option value="活動獎勵">活動獎勵</option>
                            <option value="挑戰獎勵">挑戰獎勵</option>
                            <option value="閱讀獎勵">閱讀獎勵</option>
                            <option value="管理員調整">管理員調整</option>
                            <option value="其他">其他</option>
                        </select>
                        <input type="text" id="customReason" class="reason-input" placeholder="輸入其他原因" style="display: none;">
                    </div>
                    <button class="btn" id="updatePointsBtn" style="align-self: flex-end;">更新積分</button>
                    <button class="btn btn-success" id="addUserBtn" style="align-self: flex-end;">添加用戶</button>
                    <button class="btn btn-info" id="exportUsersBtn" style="align-self: flex-end;">導出用戶</button>
                </div>
                
                <h3>用戶列表</h3>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>用戶編號</th>
                            <th>姓名</th>
                            <th>QRcode編碼</th>
                            <th>當前積分</th>
                            <th>累積積分</th>
                            <th>段位</th>
                            <th>等級</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- 用户数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="prizes-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="prizeName">獎品名稱</label>
                        <input type="text" id="prizeName" class="form-control" placeholder="輸入獎品名稱">
                    </div>
                    <div class="form-group">
                        <label for="prizePoints">所需積分</label>
                        <input type="number" id="prizePoints" class="form-control" placeholder="輸入所需積分" min="1">
                    </div>
                    <div class="form-group">
                        <label for="prizeIcon">圖標</label>
                        <input type="text" id="prizeIcon" class="form-control" placeholder="輸入FontAwesome圖標名稱" value="fa-gift">
                    </div>
                    <button class="btn btn-success" id="addPrizeBtn" style="align-self: flex-end;">添加獎品</button>
                    <button class="btn btn-info" id="exportPrizesBtn" style="align-self: flex-end;">導出獎品</button>
                </div>
                
                <h3>獎品列表</h3>
                <table class="prizes-table">
                    <thead>
                        <tr>
                            <th>獎品ID</th>
                            <th>獎品名稱</th>
                            <th>所需積分</th>
                            <th>圖標</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="prizesTableBody">
                        <!-- 奖品数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="history-admin-tab">
                <div class="search-box">
                    <input type="text" id="searchHistoryUser" class="form-control" placeholder="輸入用戶編號、姓名或QRcode編碼">
                    <button class="btn" id="searchHistoryBtn">搜索歷史紀錄</button>
                    <button class="btn btn-secondary" id="clearHistorySearchBtn">清除</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="exportHistoryBtn">導出歷史紀錄</button>
                    <button class="btn btn-warning" id="clearHistoryBtn">清空歷史紀錄</button>
                </div>
                
                <h3>積分歷史紀錄</h3>
                <div id="adminHistoryContent">
                    <!-- 管理员查看的积分历史将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="leaderboard-admin-tab">
                <h3 style="margin-bottom: 15px;">歷史積分排行榜</h3>
                <div class="leaderboard-container">
                    <div class="leaderboard-table-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>用戶姓名</th>
                                    <th>用戶編號</th>
                                    <th>累積積分</th>
                                    <th>段位</th>
                                    <th>等級</th>
                                </tr>
                            </thead>
                            <tbody id="adminLeaderboardBody">
                                <!-- 排行榜数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pie-chart-container">
                        <h4>段位分布</h4>
                        <div class="pie-chart">
                            <canvas id="adminTierPieChart"></canvas>
                        </div>
                        <div class="pie-legend" id="adminPieLegend">
                            <!-- 图例将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="stats-admin-tab">
                <h3 style="margin-bottom: 15px;">詳細統計報告</h3>
                
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalExchanges">0</div>
                        <div class="stat-label">總兌換次數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statAvgPoints">0</div>
                        <div class="stat-label">平均積分</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statActiveToday">0</div>
                        <div class="stat-label">今日活躍用戶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTopExchanger">無</div>
                        <div class="stat-label">兌換王</div>
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stats-card">
                        <h4><i class="fas fa-chart-line"></i> 積分變動趨勢</h4>
                        <div class="chart-container">
                            <canvas id="pointsTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="stats-card">
                        <h4><i class="fas fa-gift"></i> 獎品兌換統計</h4>
                        <div class="chart-container">
                            <canvas id="prizesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="stats-card">
                        <h4><i class="fas fa-history"></i> 最近活動</h4>
                        <ul class="stats-list" id="recentActivities">
                            <!-- 最近活动将通过JavaScript动态生成 -->
                        </ul>
                    </div>
                    
                    <div class="stats-card">
                        <h4><i class="fas fa-user-clock"></i> 用戶活躍度</h4>
                        <ul class="stats-list" id="userActivityStats">
                            <!-- 用户活跃度统计将通过JavaScript动态生成 -->
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-info" id="generateStatsReportBtn">生成詳細報告</button>
                    <button class="btn btn-secondary" id="refreshStatsBtn">刷新統計</button>
                </div>
            </div>
            
            <div class="tab-content" id="announcements-admin-tab">
                <h3 style="margin-bottom: 15px;">系統公告管理</h3>
                
                <div class="form-group">
                    <label for="announcementTitle">公告標題</label>
                    <input type="text" id="announcementTitle" class="form-control" placeholder="輸入公告標題" value="系統公告">
                </div>
                
                <div class="form-group">
                    <label for="announcementContentEditor">公告內容</label>
                    <textarea id="announcementContentEditor" class="form-control" rows="6" placeholder="輸入公告內容"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="announcementPriority">公告優先級</label>
                    <select id="announcementPriority" class="form-control">
                        <option value="low">低</option>
                        <option value="medium" selected>中</option>
                        <option value="high">高</option>
                        <option value="urgent">緊急</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="announcementExpiry">公告有效期（天）</label>
                    <input type="number" id="announcementExpiry" class="form-control" min="1" max="365" value="7">
                </div>
                
                <div class="data-management">
                    <button class="btn btn-success" id="publishAnnouncementBtn">發布公告</button>
                    <button class="btn btn-warning" id="clearAnnouncementBtn">清除當前公告</button>
                    <button class="btn btn-info" id="previewAnnouncementBtn">預覽公告</button>
                </div>
                
                <h4 style="margin-top: 30px;">當前公告</h4>
                <div class="announcement-card" style="margin-top: 15px;">
                    <div class="announcement-header">
                        <h5 id="currentAnnouncementTitle">無公告</h5>
                        <span id="currentAnnouncementPriority" class="badge">中</span>
                    </div>
                    <div class="announcement-content" id="currentAnnouncementContent">
                        <p>目前沒有系統公告。</p>
                    </div>
                    <div class="announcement-date">
                        發布時間: <span id="currentAnnouncementDate">無</span>
                        有效期至: <span id="currentAnnouncementExpiry">無</span>
                    </div>
                </div>
                
                <h4 style="margin-top: 30px;">歷史公告</h4>
                <div class="announcements-grid" id="announcementsList">
                    <!-- 历史公告列表将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 管理员消息管理 -->
            <div class="tab-content" id="messages-admin-tab">
                <h3 style="margin-bottom: 15px;">消息管理</h3>
                
                <div class="search-box">
                    <input type="text" id="searchAdminMessages" class="form-control" placeholder="搜索消息標題或內容">
                    <button class="btn" id="searchAdminMessagesBtn">搜索</button>
                    <select id="messageTypeFilter" class="form-control" style="width: 150px;">
                        <option value="all">所有類型</option>
                        <option value="announcement">系統公告</option>
                        <option value="feedback">反饋回覆</option>
                        <option value="mail">個人郵件</option>
                        <option value="system">系統消息</option>
                    </select>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="exportMessagesBtn">導出消息記錄</button>
                    <button class="btn btn-warning" id="clearOldMessagesBtn">清理舊消息</button>
                </div>
                
                <h4 style="margin-top: 20px;">系統消息記錄</h4>
                <div class="messages-container">
                    <div class="message-list" id="adminMessageList">
                        <!-- 管理员消息列表将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="config-admin-tab">
                <h3 style="margin-bottom: 15px;">系統參數配置</h3>
                
                <div class="config-section">
                    <h4><i class="fas fa-coins"></i> 積分規則</h4>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <strong>每日簽到積分</strong>
                            <div class="config-description">用戶每日簽到可獲得的積分</div>
                        </div>
                        <div class="config-value">
                            <input type="number" id="configDailyPoints" class="form-control config-input" min="0" max="1000" value="10">
                            <span>積分</span>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <strong>任務完成積分</strong>
                            <div class="config-description">用戶完成一個任務可獲得的積分</div>
                        </div>
                        <div class="config-value">
                            <input type="number" id="configTaskPoints" class="form-control config-input" min="0" max="1000" value="50">
                            <span>積分</span>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <strong>閱讀獎勵積分</strong>
                            <div class="config-description">用戶完成閱讀可獲得的積分</div>
                        </div>
                        <div class="config-value">
                            <input type="number" id="configReadingPoints" class="form-control config-input" min="0" max="1000" value="30">
                            <span>積分</span>
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h4><i class="fas fa-layer-group"></i> 段位標準</h4>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <strong>青銅段位</strong>
                            <div class="config-description">最低累積積分要求</div>
                        </div>
                        <div class="config-value">
                            <input type="number" id="configBronzeMin" class="form-control config-input" min="0" max="1000" value="0">
                            <span>至</span>
                            <input type="number" id="configBronzeMax" class="form-control config-input" min="0" max="10000" value="299">
                            <span>積分</span>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <strong>白銀段位</strong>
                            <div class="config-description">累積積分要求</div>
                        </div>
                        <div class="config-value">
                            <input type="number" id="configSilverMin" class="form-control config-input" min="0" max="1000" value="300">
                            <span>至</span>
                            <input type="number" id="configSilverMax" class="form-control config-input" min="0" max="10000" value="599">
                            <span>積分</span>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <strong>黃金段位</strong>
                            <div class="config-description">累積積分要求</div>
                        </div>
                        <div class="config-value">
                            <input type="number" id="configGoldMin" class="form-control config-input" min="0" max="1000" value="600">
                            <span>至</span>
                            <input type="number" id="configGoldMax" class="form-control config-input" min="0" max="10000" value="899">
                            <span>積分</span>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <strong>鉑金段位</strong>
                            <div class="config-description">累積積分要求</div>
                        </div>
                        <div class="config-value">
                            <input type="number" id="configPlatinumMin" class="form-control config-input" min="0" max="1000" value="900">
                            <span>至</span>
                            <input type="number" id="configPlatinumMax" class="form-control config-input" min="0" max="10000" value="1199">
                            <span>積分</span>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <strong>鑽石段位</strong>
                            <div class="config-description">累積積分要求</div>
                        </div>
                        <div class="config-value">
                            <input type="number" id="configDiamondMin" class="form-control config-input" min="0" max="1000" value="1200">
                            <span>至</span>
                            <input type="number" id="configDiamondMax" class="form-control config-input" min="0" max="10000" value="1499">
                            <span>積分</span>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <strong>王者段位</strong>
                            <div class="config-description">最低累積積分要求</div>
                        </div>
                        <div class="config-value">
                            <input type="number" id="configKingMin" class="form-control config-input" min="0" max="10000" value="1500">
                            <span>積分以上</span>
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h4><i class="fas fa-level-up-alt"></i> 等級系統</h4>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <strong>等級升級所需積分</strong>
                            <div class="config-description">每升一級所需的累積積分</div>
                        </div>
                        <div class="config-value">
                            <input type="number" id="configLevelIncrement" class="form-control config-input" min="100" max="5000" value="250">
                            <span>積分/級</span>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <div class="config-label">
                            <strong>最高等級</strong>
                            <div class="config-description">系統支持的最高等級</div>
                        </div>
                        <div class="config-value">
                            <input type="number" id="configMaxLevel" class="form-control config-input" min="1" max="100" value="10">
                            <span>級</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-success" id="saveConfigBtn">保存所有設定</button>
                    <button class="btn btn-secondary" id="resetConfigBtn">恢復默認設定</button>
                </div>
            </div>
            
            <div class="tab-content" id="system-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="currentPassword">當前密碼</label>
                        <input type="password" id="currentPassword" class="form-control" placeholder="輸入當前密碼">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">新密碼</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="輸入新密碼">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">確認新密碼</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="再次輸入新密碼">
                    </div>
                    <button class="btn btn-warning" id="changePasswordBtn" style="align-self: flex-end;">修改密碼</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="importDataBtn">導入歷史數據</button>
                    <button class="btn btn-success" id="exportDataBtn">導出所有數據</button>
                    <button class="btn btn-danger" id="resetDataBtn">重置所有數據</button>
                </div>
                
                <div class="form-group">
                    <label for="dataFile">選擇數據文件 (JSON格式)</label>
                    <input type="file" id="dataFile" class="form-control" accept=".json">
                </div>
                
                <h3>系统信息</h3>
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="systemUsers">0</div>
                        <div class="stat-label">用戶數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemPrizes">0</div>
                        <div class="stat-label">獎品數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemHistory">0</div>
                        <div class="stat-label">歷史紀錄</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemAdmins">0</div>
                        <div class="stat-label">管理員數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemMessages">0</div>
                        <div class="stat-label">消息數量</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="adminLogoutBtn">退出登陸</button>
        </div>
    </div>
    
    <!-- 添加用户模态框 -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加新用戶</h3>
                <button class="close-btn" id="closeAddUserModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="newUserName">用户姓名</label>
                <input type="text" id="newUserName" class="form-control" placeholder="請輸入用户姓名">
            </div>
            <div class="form-group">
                <label for="newUserId">用户編號</label>
                <input type="text" id="newUserId" class="form-control" placeholder="請輸入用户編號">
            </div>
            <div class="form-group">
                <label for="newUserPoints">初始積分</label>
                <input type="number" id="newUserPoints" class="form-control" value="0" min="0">
            </div>
            <div class="form-group">
                <label>生成的QRcode編碼: <span id="generatedBarcodeCode">BARCODE001</span></label>
            </div>
            <div class="barcode-container" id="newUserBarcode"></div>
            <button class="btn btn-success btn-block" id="confirmAddUser">確認添加用户</button>
        </div>
    </div>
    
    <!-- 编辑奖品模态框 -->
    <div class="modal" id="editPrizeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯獎品</h3>
                <button class="close-btn" id="closeEditPrizeModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="editPrizeName">獎品名稱</label>
                <input type="text" id="editPrizeName" class="form-control" placeholder="請輸入獎品名稱">
            </div>
            <div class="form-group">
                <label for="editPrizePoints">所需積分</label>
                        <input type="number" id="editPrizePoints" class="form-control" placeholder="請輸入所需積分" min="1">
            </div>
            <div class="form-group">
                <label for="editPrizeIcon">圖標類名</label>
                <input type="text" id="editPrizeIcon" class="form-control" placeholder="輸入FontAwesome圖標類名">
            </div>
            <input type="hidden" id="editPrizeId">
            <button class="btn btn-success btn-block" id="confirmEditPrize">确认修改</button>
        </div>
    </div>
    
    <!-- 条形码扫描模态框 -->
    <div class="modal" id="barcodeScannerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>掃描QRcode</h3>
                <button class="close-btn" id="closeScannerModal">&times;</button>
            </div>
            <div class="scan-area">
                <div id="scanner-container">
                    <!-- 摄像头预览将在这里显示 -->
                </div>
                <div class="scan-overlay">
                    <div class="scan-line"></div>
                </div>
            </div>
            <div class="scan-controls">
                <button class="btn" id="startScannerBtn">開始掃描</button>
                <button class="btn btn-danger" id="stopScannerBtn" style="display: none;">停止掃描</button>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label>掃描結果: <span id="scanResult">等待掃描...</span></label>
            </div>
            <button class="btn btn-success btn-block" id="confirmScanBtn" style="display: none;">確認此QRcode編碼正確？</button>
        </div>
    </div>
    
    <!-- 消息详情模态框 -->
    <div class="modal" id="messageDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>消息詳情</h3>
                <button class="close-btn" id="closeMessageDetailModal">&times;</button>
            </div>
            <div id="messageDetailContent">
                <!-- 消息详情将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 回复消息模态框 -->
    <div class="modal" id="replyMessageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>回覆消息</h3>
                <button class="close-btn" id="closeReplyMessageModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="replyMessageRecipient">收件人</label>
                <input type="text" id="replyMessageRecipient" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="replyMessageSubject">標題</label>
                <input type="text" id="replyMessageSubject" class="form-control" placeholder="輸入回覆標題">
            </div>
            <div class="form-group">
                <label for="replyMessageContent">內容</label>
                <textarea id="replyMessageContent" class="form-control" rows="6" placeholder="輸入回覆內容"></textarea>
            </div>
            <button class="btn btn-success btn-block" id="confirmReplyMessageBtn">發送回覆</button>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // 创建落叶效果
        function createLeaves() {
            const leavesContainer = document.getElementById('leaves-container');
            const leafCount = 15; // 落叶数量
            
            for (let i = 0; i < leafCount; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                
                // 随机位置
                const left = Math.random() * 100;
                leaf.style.left = left + 'vw';
                
                // 随机大小
                const size = 15 + Math.random() * 20;
                leaf.style.width = size + 'px';
                leaf.style.height = size + 'px';
                
                // 随机动画延迟和持续时间
                const delay = Math.random() * 10;
                const duration = 5 + Math.random() * 10;
                leaf.style.animationDelay = delay + 's';
                leaf.style.animationDuration = duration + 's';
                
                leavesContainer.appendChild(leaf);
            }
        }
        
        // 系统配置参数
        let systemConfig = JSON.parse(localStorage.getItem('barcodePointsConfig')) || {
            // 积分规则
            dailyPoints: 10,
            taskPoints: 50,
            readingPoints: 30,
            
            // 段位标准
            tierThresholds: [
                { name: '青銅', min: 0, max: 299, color: 'brown' },
                { name: '白銀', min: 300, max: 599, color: '#5fecfc' },
                { name: '黃金', min: 600, max: 899, color: '#ff8904' },
                { name: '鉑金', min: 900, max: 1199, color: '#75c8ff' },
                { name: '鑽石', min: 1200, max: 1499, color: '#9035F8' },
                { name: '王者', min: 1500, max: Infinity, color: '#ffd900' }
            ],
            
            // 等级系统 - 修改为250积分升一级
            levelIncrement: 250, // 每级所需增加的累积积分
            maxLevel: 10, // 最高等级
            
            // 系统公告
            announcement: {
                title: '',
                content: '',
                priority: 'medium',
                publishDate: null,
                expiryDate: null
            },
            
            // 通知偏好默认设置
            notificationPrefs: {
                achievementUnlock: true,
                pointsChange: true,
                newPrizeAvailable: true,
                systemAnnouncement: true,
                levelUp: true,
                newMessage: true
            }
        };
        
        // 用户数据存储 - 修复成就数据初始化问题
        let users = JSON.parse(localStorage.getItem('barcodePointsUsers')) || [
            { 
                id: 'U1001', 
                name: '张三', 
                barcodeCode: 'USER001', 
                points: 1500, 
                totalPoints: 2500,
                tier: '鉑金',
                level: 10,
                isAdmin: false,
                achievementTitle: '',
                achievements: ['新手求帶！😭', '低等貴族🫅', '大佬帶帶我'],
                achievementData: {
                    'new_user': true,
                    'points_collector_1': true,
                    'points_collector_2': true,
                    'points_collector_3': false,
                    'points_collector_4': false,
                    'tier_master': true,
                    'exchange_expert': false,
                    'first_exchange': false,
                    'all_achievements': false
                },
                lastActive: new Date().getTime(),
                notificationPreferences: {
                    achievementUnlock: true,
                    pointsChange: true,
                    newPrizeAvailable: true,
                    systemAnnouncement: true,
                    levelUp: true,
                    newMessage: true
                }
            },
            { 
                id: 'U1002', 
                name: '李四', 
                barcodeCode: 'USER002', 
                points: 800, 
                totalPoints: 1200,
                tier: '黃金',
                level: 4,
                isAdmin: false,
                achievementTitle: '',
                achievements: ['新手求帶！😭', '低等貴族🫅'],
                achievementData: {
                    'new_user': true,
                    'points_collector_1': true,
                    'points_collector_2': false,
                    'points_collector_3': false,
                    'points_collector_4': false,
                    'tier_master': false,
                    'exchange_expert': false,
                    'first_exchange': false,
                    'all_achievements': false
                },
                lastActive: new Date().getTime() - 86400000, // 1天前
                notificationPreferences: {
                    achievementUnlock: true,
                    pointsChange: true,
                    newPrizeAvailable: false,
                    systemAnnouncement: true,
                    levelUp: true,
                    newMessage: true
                }
            },
            { 
                id: 'U1003', 
                name: '王五', 
                barcodeCode: 'USER003', 
                points: 2200, 
                totalPoints: 3200,
                tier: '鑽石',
                level: 12,
                isAdmin: false,
                achievementTitle: '',
                achievements: ['新手求帶！😭', '低等貴族🫅', '中等貴族✨', '大佬帶帶我'],
                achievementData: {
                    'new_user': true,
                    'points_collector_1': true,
                    'points_collector_2': true,
                    'points_collector_3': true,
                    'points_collector_4': true,
                    'tier_master': true,
                    'exchange_expert': false,
                    'first_exchange': false,
                    'all_achievements': false
                },
                lastActive: new Date().getTime() - 172800000, // 2天前
                notificationPreferences: {
                    achievementUnlock: true,
                    pointsChange: false,
                    newPrizeAvailable: true,
                    systemAnnouncement: false,
                    levelUp: true,
                    newMessage: false
                }
            },
            { 
                id: 'wwlwcf002', 
                name: '管理员', 
                barcodeCode: 'wwlwcf002', 
                points: 0, 
                totalPoints: 0,
                tier: '',
                level: 0,
                achievementTitle: '',
                isAdmin: true,
                achievements: [],
                achievementData: {},
                lastActive: new Date().getTime(),
                notificationPreferences: {
                    achievementUnlock: true,
                    pointsChange: true,
                    newPrizeAvailable: true,
                    systemAnnouncement: true,
                    levelUp: true,
                    newMessage: true
                }
            }
        ];
        
        // 奖品数据存储
        let prizes = JSON.parse(localStorage.getItem('barcodePointsPrizes')) || [
            { id: 'P001', name: '咖啡券', points: 200, icon: 'fa-mug-hot', exchangeCount: 5 },
            { id: 'P002', name: '电影票', points: 500, icon: 'fa-film', exchangeCount: 3 },
            { id: 'P003', name: '蓝牙耳机', points: 1500, icon: 'fa-headphones', exchangeCount: 1 },
            { id: 'P004', name: '智能手表', points: 3000, icon: 'fa-clock', exchangeCount: 0 },
            { id: 'P005', name: '平板电脑', points: 5000, icon: 'fa-tablet-alt', exchangeCount: 0 },
            { id: 'P006', name: '购物卡', points: 1000, icon: 'fa-shopping-bag', exchangeCount: 2 }
        ];
        
        // 积分历史记录存储
        let pointsHistory = JSON.parse(localStorage.getItem('barcodePointsHistory')) || [
            { userId: 'U1001', timestamp: new Date('2023-10-01 09:30:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1001', timestamp: new Date('2023-10-05 14:20:00').getTime(), pointsChange: -200, reason: '兑换咖啡券' },
            { userId: 'U1001', timestamp: new Date('2023-10-10 11:15:00').getTime(), pointsChange: 500, reason: '活动奖励' },
            { userId: 'U1001', timestamp: new Date('2023-10-15 15:40:00').getTime(), pointsChange: 800, reason: '管理员调整' },
            { userId: 'U1002', timestamp: new Date('2023-10-02 10:45:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1002', timestamp: new Date('2023-10-07 16:30:00').getTime(), pointsChange: 300, reason: '完成任务' },
            { userId: 'U1003', timestamp: new Date('2023-10-03 08:20:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1003', timestamp: new Date('2023-10-08 13:10:00').getTime(), pointsChange: 1000, reason: '推荐用户奖励' },
            { userId: 'U1003', timestamp: new Date('2023-10-12 17:25:00').getTime(), pointsChange: 400, reason: '活动奖励' }
        ];
        
        // 新增：消息系统数据
        let messages = JSON.parse(localStorage.getItem('barcodePointsMessages')) || [
            { 
                id: 'MSG001',
                type: 'announcement',
                title: '系統更新通知',
                content: '積分系統已升級至2.0版本，新增了消息欄功能！',
                sender: 'system',
                recipient: 'all',
                timestamp: new Date('2023-10-15 09:00:00').getTime(),
                read: false,
                threadId: null,
                parentId: null
            },
            { 
                id: 'MSG002',
                type: 'mail',
                title: '歡迎使用積分系統',
                content: '歡迎您使用明馬二樓積分兌換系統，如有任何問題請隨時聯繫我們。',
                sender: 'wwlwcf002',
                recipient: 'U1001',
                timestamp: new Date('2023-10-01 09:00:00').getTime(),
                read: true,
                threadId: 'THREAD001',
                parentId: null
            },
            { 
                id: 'MSG003',
                type: 'mail',
                title: '回覆: 歡迎使用積分系統',
                content: '謝謝！我會好好使用這個系統的。',
                sender: 'U1001',
                recipient: 'wwlwcf002',
                timestamp: new Date('2023-10-01 10:30:00').getTime(),
                read: true,
                threadId: 'THREAD001',
                parentId: 'MSG002'
            },
            { 
                id: 'MSG004',
                type: 'feedback',
                title: '您的反饋已收到',
                content: '感謝您提出的寶貴建議，我們會認真考慮並在後續版本中改進。',
                sender: 'wwlwcf002',
                recipient: 'U1002',
                timestamp: new Date('2023-10-12 16:00:00').getTime(),
                read: false,
                threadId: null,
                parentId: null
            }
        ];
        
        // 新增：系统公告历史
        let announcementsHistory = JSON.parse(localStorage.getItem('barcodePointsAnnouncements')) || [];
        
        // 修改后的成就系统 - 移除积分奖励，删除活跃之王成就，添加全成就成就
        const achievements = [
            { 
                id: 'new_user', 
                name: '新手求帶！😭', 
                description: '積分達到100分', 
                icon: 'fa-baby', 
                reward: '榮譽成就，無積分獎勵',
                condition: (user, data) => user.totalPoints >= 100,
                progress: (user, data) => Math.min(100, (user.totalPoints / 100) * 100),
                getData: (user) => ({})
            },
            { 
                id: 'points_collector_1', 
                name: '低等貴族🫅', 
                description: '累積積分達到500點', 
                icon: 'fa-crown', 
                reward: '榮譽成就，無積分獎勵',
                condition: (user, data) => user.totalPoints >= 500,
                progress: (user, data) => Math.min(100, (user.totalPoints / 500) * 100),
                getData: (user) => ({})
            },
            { 
                id: 'points_collector_2', 
                name: '中等貴族✨', 
                description: '累積積分達到1200點', 
                icon: 'fa-gem', 
                reward: '榮譽成就，無積分獎勵',
                condition: (user, data) => user.totalPoints >= 1200,
                progress: (user, data) => Math.min(100, (user.totalPoints / 1200) * 100),
                getData: (user) => ({})
            },
            { 
                id: 'points_collector_3', 
                name: '💎高等貴族💎', 
                description: '累積積分達到2000點', 
                icon: 'fa-diamond', 
                reward: '榮譽成就，無積分獎勵',
                condition: (user, data) => user.totalPoints >= 2000,
                progress: (user, data) => Math.min(100, (user.totalPoints / 2000) * 100),
                getData: (user) => ({})
            },
            { 
                id: 'points_collector_4', 
                name: '👑全服之王👑', 
                description: '累積積分達到3000點',
                icon: 'fa-trophy', 
                reward: '榮譽成就，無積分獎勵',
                condition: (user, data) => user.totalPoints >= 3000,
                progress: (user, data) => Math.min(100, (user.totalPoints / 3000) * 100),
                getData: (user) => ({})
            },
            { 
                id: 'tier_master', 
                name: '大佬帶帶我', 
                description: '達到鉑金段位', 
                icon: 'fa-star', 
                reward: '榮譽成就，無積分獎勵',
                condition: (user, data) => user.tier === '鉑金' || user.tier === '鑽石' || user.tier === '王者',
                progress: (user, data) => {
                    const tiers = ['青銅', '白銀', '黃金', '鉑金', '鑽石', '王者'];
                    const currentIndex = tiers.indexOf(user.tier);
                    return Math.min(100, ((currentIndex + 1) / 4) * 100);
                },
                getData: (user) => ({})
            },
            { 
                id: 'exchange_expert', 
                name: '兄弟手頭有點緊啊～', 
                description: '成功兌換5次獎品', 
                icon: 'fa-gift', 
                reward: '榮譽成就，無積分獎勵',
                condition: (user, data) => {
                    if (!data || !data.exchangeCount) return false;
                    return data.exchangeCount >= 5;
                },
                progress: (user, data) => {
                    const exchangeCount = data && data.exchangeCount ? data.exchangeCount : 0;
                    return Math.min(100, (exchangeCount / 5) * 100);
                },
                getData: (user) => {
                    const exchangeCount = pointsHistory.filter(h => 
                        h.userId === user.id && h.pointsChange < 0 && h.reason.includes('兌換獎品')
                    ).length;
                    return { exchangeCount };
                }
            },
            { 
                id: 'first_exchange', 
                name: '首次兌換', 
                description: '第一次兌換獎品', 
                icon: 'fa-shopping-cart', 
                reward: '榮譽成就，無積分獎勵',
                condition: (user, data) => {
                    if (!data || !data.hasExchanged) return false;
                    return data.hasExchanged;
                },
                progress: (user, data) => {
                    const hasExchanged = data && data.hasExchanged ? data.hasExchanged : false;
                    return hasExchanged ? 100 : 0;
                },
                getData: (user) => {
                    const hasExchanged = pointsHistory.some(h => 
                        h.userId === user.id && h.pointsChange < 0 && h.reason.includes('兌換獎品')
                    );
                    return { hasExchanged };
                }
            },
            { 
                id: 'all_achievements', 
                name: '🏆全成就大師🏆', 
                description: '完成所有成就', 
                icon: 'fa-medal', 
                reward: '榮譽稱號：全成就大師',
                condition: (user, data) => {
                    // 检查是否完成了除本成就外的所有成就
                    const otherAchievements = achievements.filter(a => a.id !== 'all_achievements');
                    for (const achievement of otherAchievements) {
                        const achievementData = achievement.getData ? achievement.getData(user) : {};
                        if (!achievement.condition(user, achievementData)) {
                            return false;
                        }
                    }
                    return true;
                },
                progress: (user, data) => {
                    // 计算已完成成就的比例
                    const otherAchievements = achievements.filter(a => a.id !== 'all_achievements');
                    let completed = 0;
                    for (const achievement of otherAchievements) {
                        const achievementData = achievement.getData ? achievement.getData(user) : {};
                        if (achievement.condition(user, achievementData)) {
                            completed++;
                        }
                    }
                    return Math.min(100, (completed / otherAchievements.length) * 100);
                },
                getData: (user) => ({})
            }
        ];
        
        // 管理员密码
        const adminPassword = 'admin123';
        
        // 当前登录的管理员ID
        let currentAdminId = '';
        
        // 当前兑换的奖品ID（用于兑换确认）
        let currentRedeemPrizeId = '';
        
        // DOM元素
        const pageLoader = document.getElementById('pageLoader');
        const loginSection = document.getElementById('loginSection');
        const userDashboard = document.getElementById('userDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const userBarcodeScan = document.getElementById('userBarcodeScan');
        const adminBarcodeScan = document.getElementById('adminBarcodeScan');
        const userLoginBtn = document.getElementById('userLoginBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const userLogoutBtn = document.getElementById('userLogoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const prizesGrid = document.getElementById('prizesGrid');
        const usersTableBody = document.getElementById('usersTableBody');
        const prizesTableBody = document.getElementById('prizesTableBody');
        const updatePointsBtn = document.getElementById('updatePointsBtn');
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserModal = document.getElementById('addUserModal');
        const closeAddUserModal = document.getElementById('closeAddUserModal');
        const confirmAddUser = document.getElementById('confirmAddUser');
        const generatedBarcodeCode = document.getElementById('generatedBarcodeCode');
        const newUserBarcode = document.getElementById('newUserBarcode');
        const addPrizeBtn = document.getElementById('addPrizeBtn');
        const editPrizeModal = document.getElementById('editPrizeModal');
        const closeEditPrizeModal = document.getElementById('closeEditPrizeModal');
        const confirmEditPrize = document.getElementById('confirmEditPrize');
        const searchHistoryBtn = document.getElementById('searchHistoryBtn');
        const barcodeScannerModal = document.getElementById('barcodeScannerModal');
        const closeScannerModal = document.getElementById('closeScannerModal');
        const startScannerBtn = document.getElementById('startScannerBtn');
        const stopScannerBtn = document.getElementById('stopScannerBtn');
        const scanResult = document.getElementById('scanResult');
        const confirmScanBtn = document.getElementById('confirmScanBtn');
        const userIdInput = document.getElementById('userIdInput');
        const userBarcodeDisplay = document.getElementById('userBarcodeDisplay');
        const notification = document.getElementById('notification');
        const achievementNotification = document.getElementById('achievementNotification');
        const achievementNotificationName = document.getElementById('achievementNotificationName');
        const achievementNotificationDesc = document.getElementById('achievementNotificationDesc');
        const achievementNotificationReward = document.getElementById('achievementNotificationReward');
        const closeAchievementNotification = document.getElementById('closeAchievementNotification');
        const userLeaderboardBody = document.getElementById('userLeaderboardBody');
        const adminLeaderboardBody = document.getElementById('adminLeaderboardBody');
        const tierPieChart = document.getElementById('tierPieChart');
        const adminTierPieChart = document.getElementById('adminTierPieChart');
        const pieLegend = document.getElementById('pieLegend');
        const adminPieLegend = document.getElementById('adminPieLegend');
        const themeToggle = document.getElementById('themeToggle');
        const achievementsGrid = document.getElementById('achievementsGrid');
        
        // 新增DOM元素
        const announcementSection = document.getElementById('announcementSection');
        const announcementContent = document.getElementById('announcementContent');
        const announcementDate = document.getElementById('announcementDate');
        const closeAnnouncementBtn = document.getElementById('closeAnnouncementBtn');
        const redeemConfirmModal = document.getElementById('redeemConfirmModal');
        const closeRedeemModal = document.getElementById('closeRedeemModal');
        const confirmPrizeName = document.getElementById('confirmPrizeName');
        const confirmPrizePoints = document.getElementById('confirmPrizePoints');
        const confirmPrizeIcon = document.getElementById('confirmPrizeIcon');
        const confirmUserCurrentPoints = document.getElementById('confirmUserCurrentPoints');
        const confirmUserAfterPoints = document.getElementById('confirmUserAfterPoints');
        const cancelRedeemBtn = document.getElementById('cancelRedeemBtn');
        const confirmRedeemBtn = document.getElementById('confirmRedeemBtn');
        const notificationPreferences = document.getElementById('notificationPreferences');
        const saveNotificationPrefsBtn = document.getElementById('saveNotificationPrefsBtn');
        const userLevelProgress = document.getElementById('userLevelProgress');
        const levelProgressText = document.getElementById('levelProgressText');
        const levelProgressFill = document.getElementById('levelProgressFill');
        
        // 消息欄相關元素
        const messageList = document.getElementById('messageList');
        const messageFilters = document.querySelectorAll('.message-filter-btn');
        const newMessageBtn = document.getElementById('newMessageBtn');
        const newMessageForm = document.getElementById('newMessageForm');
        const messageRecipient = document.getElementById('messageRecipient');
        const messageSubject = document.getElementById('messageSubject');
        const messageContent = document.getElementById('messageContent');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const cancelMessageBtn = document.getElementById('cancelMessageBtn');
        const markAllAsReadBtn = document.getElementById('markAllAsReadBtn');
        const messageDetailModal = document.getElementById('messageDetailModal');
        const closeMessageDetailModal = document.getElementById('closeMessageDetailModal');
        const messageDetailContent = document.getElementById('messageDetailContent');
        const replyMessageModal = document.getElementById('replyMessageModal');
        const closeReplyMessageModal = document.getElementById('closeReplyMessageModal');
        const replyMessageRecipient = document.getElementById('replyMessageRecipient');
        const replyMessageSubject = document.getElementById('replyMessageSubject');
        const replyMessageContent = document.getElementById('replyMessageContent');
        const confirmReplyMessageBtn = document.getElementById('confirmReplyMessageBtn');
        
        // 管理员新增DOM元素
        const pointsTrendChart = document.getElementById('pointsTrendChart');
        const prizesChart = document.getElementById('prizesChart');
        const recentActivities = document.getElementById('recentActivities');
        const userActivityStats = document.getElementById('userActivityStats');
        const generateStatsReportBtn = document.getElementById('generateStatsReportBtn');
        const refreshStatsBtn = document.getElementById('refreshStatsBtn');
        const statTotalExchanges = document.getElementById('statTotalExchanges');
        const statAvgPoints = document.getElementById('statAvgPoints');
        const statActiveToday = document.getElementById('statActiveToday');
        const statTopExchanger = document.getElementById('statTopExchanger');
        
        const announcementTitle = document.getElementById('announcementTitle');
        const announcementContentEditor = document.getElementById('announcementContentEditor');
        const announcementPriority = document.getElementById('announcementPriority');
        const announcementExpiry = document.getElementById('announcementExpiry');
        const publishAnnouncementBtn = document.getElementById('publishAnnouncementBtn');
        const clearAnnouncementBtn = document.getElementById('clearAnnouncementBtn');
        const previewAnnouncementBtn = document.getElementById('previewAnnouncementBtn');
        const currentAnnouncementTitle = document.getElementById('currentAnnouncementTitle');
        const currentAnnouncementContent = document.getElementById('currentAnnouncementContent');
        const currentAnnouncementDate = document.getElementById('currentAnnouncementDate');
        const currentAnnouncementExpiry = document.getElementById('currentAnnouncementExpiry');
        const currentAnnouncementPriority = document.getElementById('currentAnnouncementPriority');
        
        const configDailyPoints = document.getElementById('configDailyPoints');
        const configTaskPoints = document.getElementById('configTaskPoints');
        const configReadingPoints = document.getElementById('configReadingPoints');
        const configBronzeMin = document.getElementById('configBronzeMin');
        const configBronzeMax = document.getElementById('configBronzeMax');
        const configSilverMin = document.getElementById('configSilverMin');
        const configSilverMax = document.getElementById('configSilverMax');
        const configGoldMin = document.getElementById('configGoldMin');
        const configGoldMax = document.getElementById('configGoldMax');
        const configPlatinumMin = document.getElementById('configPlatinumMin');
        const configPlatinumMax = document.getElementById('configPlatinumMax');
        const configDiamondMin = document.getElementById('configDiamondMin');
        const configDiamondMax = document.getElementById('configDiamondMax');
        const configKingMin = document.getElementById('configKingMin');
        const configLevelIncrement = document.getElementById('configLevelIncrement');
        const configMaxLevel = document.getElementById('configMaxLevel');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const resetConfigBtn = document.getElementById('resetConfigBtn');
        
        // 登录选项切换
        const userCodeLoginBtn = document.getElementById('userCodeLoginBtn');
        const userBarcodeLoginBtn = document.getElementById('userBarcodeLoginBtn');
        const userCodeLoginForm = document.getElementById('userCodeLoginForm');
        const userBarcodeLoginForm = document.getElementById('userBarcodeLoginForm');
        
        const adminCodeLoginBtn = document.getElementById('adminCodeLoginBtn');
        const adminBarcodeLoginBtn = document.getElementById('adminBarcodeLoginBtn');
        const adminCodeLoginForm = document.getElementById('adminCodeLoginForm');
        const adminBarcodeLoginForm = document.getElementById('adminBarcodeLoginForm');
        
        // 新增功能元素
        const searchUserBtn = document.getElementById('searchUserBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const exportUsersBtn = document.getElementById('exportUsersBtn');
        const exportPrizesBtn = document.getElementById('exportPrizesBtn');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const clearHistorySearchBtn = document.getElementById('clearHistorySearchBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const dataFile = document.getElementById('dataFile');
        const pointsReason = document.getElementById('pointsReason');
        const customReason = document.getElementById('customReason');
        
        // 管理员消息管理元素
        const searchAdminMessagesBtn = document.getElementById('searchAdminMessagesBtn');
        const messageTypeFilter = document.getElementById('messageTypeFilter');
        const adminMessageList = document.getElementById('adminMessageList');
        const exportMessagesBtn = document.getElementById('exportMessagesBtn');
        const clearOldMessagesBtn = document.getElementById('clearOldMessagesBtn');
        
        // 当前登录的用户和管理员
        let currentUser = null;
        let currentAdmin = false;
        let scannerActive = false;
        let scannedBarcode = '';
        let scannerType = '';
        let pieChartAnimations = {};
        let achievementNotificationTimeout = null;
        let charts = {};
        
        // 初始化页面
        function initPage() {
            // 隐藏加载动画
            setTimeout(() => {
                pageLoader.style.opacity = '0';
                setTimeout(() => {
                    pageLoader.style.display = 'none';
                }, 500);
            }, 1500); // 保持初始化时间
            
            // 创建落叶效果
            createLeaves();
            
            // 保存初始数据到localStorage
            saveDataToStorage();
            saveConfigToStorage();
            saveMessagesToStorage();
            
            // 检查并显示公告
            checkAndShowAnnouncement();
            
            // 渲染组件
            renderPrizes();
            renderUsersTable();
            renderPrizesTable();
            setupTabs();
            setupLoginOptions();
            updateSystemStats();
            
            // 加载系统配置到界面
            loadConfigToUI();
            
            // 主题切换
            themeToggle.addEventListener('click', toggleTheme);
            
            // 检查是否已保存主题偏好
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('theme-dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // 积分变更原因选择事件
            pointsReason.addEventListener('change', function() {
                if (this.value === '其他') {
                    customReason.style.display = 'block';
                } else {
                    customReason.style.display = 'none';
                    customReason.value = '';
                }
            });
            
            // 成就通知关闭按钮事件
            closeAchievementNotification.addEventListener('click', function() {
                achievementNotification.classList.remove('unlocked');
                if (achievementNotificationTimeout) {
                    clearTimeout(achievementNotificationTimeout);
                }
            });
            
            // 用户登录按钮事件
            userLoginBtn.addEventListener('click', function() {
                const userId = userIdInput.value;
                if (userId) {
                    loginWithUserId(userId);
                } else {
                    showNotification('請輸入用戶編號', 'error');
                }
            });
            
            // 用户条形码扫描事件
            userBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('user');
            });
            
            // 管理员条形码扫描事件
            adminBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('admin');
            });
            
            // 管理员登录按钮事件
            adminLoginBtn.addEventListener('click', function() {
                const adminId = document.getElementById('adminId').value;
                const password = document.getElementById('adminPassword').value;
                
                if (adminId && password) {
                    loginAdminWithCredentials(adminId, password);
                } else {
                    showNotification('請輸入管理員編號和密碼', 'error');
                }
            });
            
            // 用户退出登录
            userLogoutBtn.addEventListener('click', function() {
                currentUser = null;
                showLoginSection();
                showNotification('已登出用戶登錄', 'info');
            });
            
            // 管理员退出登录
            adminLogoutBtn.addEventListener('click', function() {
                // 询问是否要下载备份
                if (confirm('是否要下載最新的系統文件？')) {
                    exportAllData();
                }
                currentAdmin = false;
                currentAdminId = '';
                document.getElementById('adminId').value = '';
                document.getElementById('adminPassword').value = '';
                showLoginSection();
                showNotification('已登出管理員登陸', 'info');
            });
            
            // 更新积分按钮事件 - 添加成功提示
            updatePointsBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                const pointsChange = parseInt(document.getElementById('pointsChange').value);
                let reason = pointsReason.value;
                
                if (reason === '其他') {
                    reason = customReason.value;
                }
                
                if (!searchTerm || isNaN(pointsChange)) {
                    showNotification('請輸入有效的變更值和用戶編號', 'error');
                    return;
                }
                
                if (!reason) {
                    showNotification('請選擇或輸入變更原因', 'error');
                    return;
                }
                
                const user = users.find(u => 
                    u.id === searchTerm || 
                    u.name === searchTerm || 
                    u.barcodeCode === searchTerm
                );
                
                if (user) {
                    user.points += pointsChange;
                    if (user.points < 0) user.points = 0;
                    
                    // 如果是增加积分，同时增加累积积分
                    if (pointsChange > 0) {
                        user.totalPoints += pointsChange;
                    }
                    
                    // 更新段位和等级 - 修复等级计算
                    user.tier = calculateUserTier(user.totalPoints);
                    user.level = calculateUserLevel(user.totalPoints);
                    
                    // 更新最后活动时间
                    user.lastActive = new Date().getTime();
                    
                    // 检查成就
                    checkAchievements(user);
                    
                    // 记录积分变更历史
                    pointsHistory.push({
                        userId: user.id,
                        timestamp: new Date().getTime(),
                        pointsChange: pointsChange,
                        reason: reason
                    });
                    
                    // 保存数据
                    saveDataToStorage();
                    
                    renderUsersTable();
                    updateSystemStats();
                    document.getElementById('pointsChange').value = '';
                    pointsReason.value = '';
                    customReason.value = '';
                    customReason.style.display = 'none';
                    
                    // 添加成功提示
                    showNotification(`成功更新 ${user.name} 的積分！變更: ${pointsChange > 0 ? '+' : ''}${pointsChange}`, 'success');
                } else {
                    showNotification('未找到該用戶', 'error');
                }
            });
            
            // 添加用户按钮事件
            addUserBtn.addEventListener('click', function() {
                // 生成随机条形码编码
                const newBarcodeCode = generateBarcodeCode();
                generatedBarcodeCode.textContent = newBarcodeCode;
                
                // 生成条形码 - 添加延迟确保DOM更新
                setTimeout(() => {
                    generateBarcode(newBarcodeCode, newUserBarcode);
                }, 100);
                
                // 显示模态框
                addUserModal.style.display = 'flex';
            });
            
            // 关闭添加用户模态框
            closeAddUserModal.addEventListener('click', function() {
                addUserModal.style.display = 'none';
            });
            
            // 确认添加用户
            confirmAddUser.addEventListener('click', function() {
                const userName = document.getElementById('newUserName').value;
                const userId = document.getElementById('newUserId').value;
                const userPoints = parseInt(document.getElementById('newUserPoints').value) || 0;
                const barcodeCode = generatedBarcodeCode.textContent;
                
                if (!userName || !userId) {
                    showNotification('請輸入用戶姓名或編號', 'error');
                    return;
                }
                
                // 检查用户编号是否已存在
                if (users.find(u => u.id === userId)) {
                    showNotification('用戶編號已存在，請使用其他編號', 'error');
                    return;
                }
                
                // 计算段位和等级 - 修复等级计算
                const userTier = calculateUserTier(userPoints);
                const userLevel = calculateUserLevel(userPoints);
                
                // 添加新用户
                const newUser = {
                    id: userId,
                    name: userName,
                    barcodeCode: barcodeCode,
                    points: userPoints,
                    totalPoints: userPoints, // 初始累积积分等于当前积分
                    tier: userTier, // 初始段位
                    level: userLevel, // 初始等级
                    achievementTitle: '無',
                    isAdmin: false,
                    achievements: [], // 初始成就
                    achievementData: {}, // 初始成就数据
                    lastActive: new Date().getTime(),
                    notificationPreferences: JSON.parse(JSON.stringify(systemConfig.notificationPrefs)) // 复制默认偏好设置
                };
                
                // 检查初始成就
                checkAchievements(newUser);
                
                users.push(newUser);
                
                // 记录初始积分历史
                if (userPoints > 0) {
                    pointsHistory.push({
                        userId: userId,
                        timestamp: new Date().getTime(),
                        pointsChange: userPoints,
                        reason: '初始積分'
                    });
                }
                
                // 保存数据
                saveDataToStorage();
                
                // 更新界面
                renderUsersTable();
                updateSystemStats();
                
                // 关闭模态框并重置表单
                addUserModal.style.display = 'none';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserId').value = '';
                document.getElementById('newUserPoints').value = '0';
                
                showNotification(`成功添加用户 ${userName}，条形码编码: ${barcodeCode}`, 'success');
            });
            
            // 添加奖品按钮事件
            addPrizeBtn.addEventListener('click', function() {
                const prizeName = document.getElementById('prizeName').value;
                const prizePoints = parseInt(document.getElementById('prizePoints').value);
                const prizeIcon = document.getElementById('prizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('請輸入有效的獎品信息', 'error');
                    return;
                }
                
                // 生成奖品ID
                const prizeId = generatePrizeId();
                
                // 添加新奖品
                prizes.push({
                    id: prizeId,
                    name: prizeName,
                    points: prizePoints,
                    icon: prizeIcon,
                    exchangeCount: 0
                });
                
                // 保存数据
                saveDataToStorage();
                
                // 更新界面
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                // 重置表单
                document.getElementById('prizeName').value = '';
                document.getElementById('prizePoints').value = '';
                document.getElementById('prizeIcon').value = 'fa-gift';
                
                showNotification(`成功添加獎品 ${prizeName}`, 'success');
            });
            
            // 关闭编辑奖品模态框
            closeEditPrizeModal.addEventListener('click', function() {
                editPrizeModal.style.display = 'none';
            });
            
            // 确认编辑奖品
            confirmEditPrize.addEventListener('click', function() {
                const prizeId = document.getElementById('editPrizeId').value;
                const prizeName = document.getElementById('editPrizeName').value;
                const prizePoints = parseInt(document.getElementById('editPrizePoints').value);
                const prizeIcon = document.getElementById('editPrizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('請輸入有效的奖品信息', 'error');
                    return;
                }
                
                // 更新奖品信息
                const prize = prizes.find(p => p.id === prizeId);
                if (prize) {
                    prize.name = prizeName;
                    prize.points = prizePoints;
                    prize.icon = prizeIcon;
                    
                    // 保存数据
                    saveDataToStorage();
                    
                    // 更新界面
                    renderPrizesTable();
                    renderPrizes();
                    
                    // 关闭模态框
                    editPrizeModal.style.display = 'none';
                    
                    showNotification(`成功更新獎品 ${prizeName}`, 'success');
                }
            });
            
            // 搜索历史记录按钮事件
            searchHistoryBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchHistoryUser').value;
                renderAdminHistory(searchTerm);
            });
            
            // 条形码扫描模态框事件
            closeScannerModal.addEventListener('click', function() {
                closeBarcodeScanner();
            });
            
            startScannerBtn.addEventListener('click', function() {
                startBarcodeScanner();
            });
            
            stopScannerBtn.addEventListener('click', function() {
                stopBarcodeScanner();
            });
            
            confirmScanBtn.addEventListener('click', function() {
                if (scannedBarcode) {
                    if (scannerType === 'user') {
                        loginWithBarcode(scannedBarcode);
                    } else if (scannerType === 'admin') {
                        loginAdminWithBarcode(scannedBarcode);
                    }
                    closeBarcodeScanner();
                }
            });
            
            // 新增功能事件
            searchUserBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                renderUsersTable(searchTerm);
            });
            
            clearSearchBtn.addEventListener('click', function() {
                document.getElementById('searchUser').value = '';
                renderUsersTable();
            });
            
            exportUsersBtn.addEventListener('click', function() {
                exportUsersData();
            });
            
            exportPrizesBtn.addEventListener('click', function() {
                exportPrizesData();
            });
            
            exportHistoryBtn.addEventListener('click', function() {
                exportHistoryData();
            });
            
            clearHistoryBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有積分歷史紀錄吗？此操作不可恢復！')) {
                    pointsHistory = [];
                    saveDataToStorage();
                    renderAdminHistory();
                    updateSystemStats();
                    showNotification('歷史紀錄已清空', 'success');
                }
            });
            
            clearHistorySearchBtn.addEventListener('click', function() {
                document.getElementById('searchHistoryUser').value = '';
                renderAdminHistory();
            });
            
            changePasswordBtn.addEventListener('click', function() {
                changeAdminPassword();
            });
            
            importDataBtn.addEventListener('click', function() {
                dataFile.click();
            });
            
            exportDataBtn.addEventListener('click', function() {
                exportAllData();
            });
            
            resetDataBtn.addEventListener('click', function() {
                resetSystemData();
            });
            
            dataFile.addEventListener('change', function(e) {
                importData(e);
            });
            
            // 新功能事件绑定
            closeAnnouncementBtn.addEventListener('click', function() {
                announcementSection.style.display = 'none';
            });
            
            closeRedeemModal.addEventListener('click', function() {
                redeemConfirmModal.style.display = 'none';
            });
            
            cancelRedeemBtn.addEventListener('click', function() {
                redeemConfirmModal.style.display = 'none';
            });
            
            confirmRedeemBtn.addEventListener('click', function() {
                if (currentRedeemPrizeId && currentUser) {
                    redeemPrizeConfirmed(currentRedeemPrizeId);
                }
            });
            
            saveNotificationPrefsBtn.addEventListener('click', function() {
                saveNotificationPreferences();
            });
            
            // 管理员新功能事件绑定
            generateStatsReportBtn.addEventListener('click', function() {
                generateDetailedStatsReport();
            });
            
            refreshStatsBtn.addEventListener('click', function() {
                updateAdminStats();
            });
            
            publishAnnouncementBtn.addEventListener('click', function() {
                publishAnnouncement();
            });
            
            clearAnnouncementBtn.addEventListener('click', function() {
                clearAnnouncement();
            });
            
            previewAnnouncementBtn.addEventListener('click', function() {
                previewAnnouncement();
            });
            
            saveConfigBtn.addEventListener('click', function() {
                saveSystemConfig();
            });
            
            resetConfigBtn.addEventListener('click', function() {
                resetSystemConfig();
            });
            
            // 消息欄事件绑定
            setupMessageEvents();
            
            // 管理员消息管理事件
            searchAdminMessagesBtn.addEventListener('click', function() {
                renderAdminMessages();
            });
            
            messageTypeFilter.addEventListener('change', function() {
                renderAdminMessages();
            });
            
            exportMessagesBtn.addEventListener('click', function() {
                exportMessagesData();
            });
            
            clearOldMessagesBtn.addEventListener('click', function() {
                clearOldMessages();
            });
        }
        
        // 消息欄事件設置
        function setupMessageEvents() {
            // 消息过滤器点击事件
            messageFilters.forEach(filter => {
                filter.addEventListener('click', function() {
                    // 移除所有active类
                    messageFilters.forEach(f => f.classList.remove('active'));
                    
                    // 添加active类到当前按钮
                    this.classList.add('active');
                    
                    // 重新渲染消息列表
                    const filterType = this.getAttribute('data-type');
                    renderMessageList(filterType);
                });
            });
            
            // 新消息按钮事件
            newMessageBtn.addEventListener('click', function() {
                newMessageForm.style.display = 'block';
                renderMessageRecipientList();
            });
            
            // 取消发送消息
            cancelMessageBtn.addEventListener('click', function() {
                newMessageForm.style.display = 'none';
                messageSubject.value = '';
                messageContent.value = '';
            });
            
            // 发送消息
            sendMessageBtn.addEventListener('click', function() {
                sendMessage();
            });
            
            // 标记全部为已读
            markAllAsReadBtn.addEventListener('click', function() {
                markAllMessagesAsRead();
            });
            
            // 关闭消息详情模态框
            closeMessageDetailModal.addEventListener('click', function() {
                messageDetailModal.style.display = 'none';
            });
            
            // 关闭回复消息模态框
            closeReplyMessageModal.addEventListener('click', function() {
                replyMessageModal.style.display = 'none';
            });
            
            // 确认回复消息
            confirmReplyMessageBtn.addEventListener('click', function() {
                sendReplyMessage();
            });
        }
        
        // 主题切换
        function toggleTheme() {
            document.body.classList.toggle('theme-dark');
            if (document.body.classList.contains('theme-dark')) {
                localStorage.setItem('theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                localStorage.setItem('theme', 'light');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        // 设置登录选项切换 - 修复版
        function setupLoginOptions() {
            // 用户登录选项
            userCodeLoginBtn.addEventListener('click', function() {
                // 移除所有active类
                document.querySelectorAll('#userCodeLoginBtn, #userBarcodeLoginBtn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // 添加active类到当前按钮
                this.classList.add('active');
                
                // 切换表单显示
                userCodeLoginForm.style.display = 'block';
                userBarcodeLoginForm.style.display = 'none';
            });
            
            userBarcodeLoginBtn.addEventListener('click', function() {
                // 移除所有active类
                document.querySelectorAll('#userCodeLoginBtn, #userBarcodeLoginBtn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // 添加active类到当前按钮
                this.classList.add('active');
                
                // 切换表单显示
                userCodeLoginForm.style.display = 'none';
                userBarcodeLoginForm.style.display = 'block';
            });
            
            // 管理员登录选项
            adminCodeLoginBtn.addEventListener('click', function() {
                // 移除所有active类
                document.querySelectorAll('#adminCodeLoginBtn, #adminBarcodeLoginBtn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // 添加active类到当前按钮
                this.classList.add('active');
                
                // 切换表单显示
                adminCodeLoginForm.style.display = 'block';
                adminBarcodeLoginForm.style.display = 'none';
            });
            
            adminBarcodeLoginBtn.addEventListener('click', function() {
                // 移除所有active类
                document.querySelectorAll('#adminCodeLoginBtn, #adminBarcodeLoginBtn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // 添加active类到当前按钮
                this.classList.add('active');
                
                // 切换表单显示
                adminCodeLoginForm.style.display = 'none';
                adminBarcodeLoginForm.style.display = 'block';
            });
        }
        
        // 设置选项卡切换
        function setupTabs() {
            // 用户界面选项卡
            const userTabs = document.querySelectorAll('#userDashboard .tab');
            userTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    userTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#userDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 根据选项卡类型执行相应操作
                    switch(tabId) {
                        case 'history':
                            renderUserHistory();
                            break;
                        case 'leaderboard':
                            renderUserLeaderboard();
                            renderTierPieChartWithAnimation(tierPieChart, pieLegend);
                            break;
                        case 'achievements':
                            renderAchievements();
                            break;
                        case 'messages':
                            renderMessageList('all');
                            break;
                        case 'notifications':
                            renderNotificationPreferences();
                            break;
                    }
                });
            });
            
            // 管理员界面选项卡
            const adminTabs = document.querySelectorAll('#adminDashboard .tab');
            adminTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    adminTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#adminDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 根据选项卡类型执行相应操作
                    switch(tabId) {
                        case 'history-admin':
                            renderAdminHistory();
                            break;
                        case 'leaderboard-admin':
                            renderAdminLeaderboard();
                            renderTierPieChartWithAnimation(adminTierPieChart, adminPieLegend);
                            break;
                        case 'stats-admin':
                            updateAdminStats();
                            break;
                        case 'announcements-admin':
                            updateCurrentAnnouncementDisplay();
                            renderAnnouncementsHistory();
                            break;
                        case 'messages-admin':
                            renderAdminMessages();
                            break;
                        case 'config-admin':
                            loadConfigToUI();
                            break;
                        case 'system-admin':
                            updateSystemStats();
                            break;
                    }
                });
            });
        }
        
        // 使用用户编号登录
        function loginWithUserId(userId) {
            const user = users.find(u => u.id === userId && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                // 用户登录时检查成就
                checkAchievements(currentUser);
                showNotification(`用户 ${user.name} 登錄成功！`, 'success');
                
                // 检查未读消息数量
                checkUnreadMessages();
            } else {
                showNotification('用户編號錯誤或不是普通用户', 'error');
            }
        }
        
        // 使用条形码登录
        function loginWithBarcode(barcode) {
            const user = users.find(u => u.barcodeCode === barcode && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                // 用户登录时检查成就
                checkAchievements(currentUser);
                showNotification(`用户 ${user.name} 登錄成功！`, 'success');
                
                // 检查未读消息数量
                checkUnreadMessages();
            } else {
                showNotification('QRcode錯誤或不是普通用户', 'error');
            }
        }
        
        // 使用管理员凭据登录
        function loginAdminWithCredentials(adminId, password) {
            if (password === adminPassword) {
                const adminUser = users.find(u => u.id === adminId && u.isAdmin);
                if (adminUser) {
                    currentAdmin = true;
                    currentAdminId = adminId; // 记录当前管理员ID
                    showAdminDashboard();
                    showNotification('管理員登陸成功！', 'success');
                } else {
                    showNotification('管理員編號錯誤！', 'error');
                }
            } else {
                showNotification('密碼錯誤，請重試！', 'error');
            }
        }
        
        // 使用管理员条形码登录
        function loginAdminWithBarcode(barcode) {
            const adminUser = users.find(u => u.barcodeCode === barcode && u.isAdmin);
            if (adminUser) {
                currentAdmin = true;
                currentAdminId = adminUser.id; // 记录当前管理员ID
                showAdminDashboard();
                showNotification('管理員登錄成功！', 'success');
            } else {
                showNotification('管理員QRcode錯誤！', 'error');
            }
        }
        
        // 打开条形码扫描器
        function openBarcodeScanner(type) {
            scannerType = type;
            barcodeScannerModal.style.display = 'flex';
            scanResult.textContent = '等待掃描...';
            confirmScanBtn.style.display = 'none';
            scannedBarcode = '';
        }
        
        // 关闭条形码扫描器
        function closeBarcodeScanner() {
            barcodeScannerModal.style.display = 'none';
            stopBarcodeScanner();
        }
        
        // 开始条形码扫描
        function startBarcodeScanner() {
            if (scannerActive) return;
            
            const scannerContainer = document.getElementById('scanner-container');
            scannerContainer.innerHTML = '';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerContainer,
                    constraints: {
                        width: 480,
                        height: 320,
                        facingMode: "environment" // 使用后置攝像頭
                    }
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "upc_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    showNotification('無法啟動攝像頭: ' + err, 'error');
                    return;
                }
                Quagga.start();
                scannerActive = true;
                startScannerBtn.style.display = 'none';
                stopScannerBtn.style.display = 'inline-block';
            });
            
            Quagga.onDetected(function(result) {
                if (result && result.codeResult) {
                    scannedBarcode = result.codeResult.code;
                    scanResult.textContent = scannedBarcode;
                    confirmScanBtn.style.display = 'block';
                    showNotification('監測到QRcode: ' + scannedBarcode, 'success');
                    
                    // 自动停止扫描
                    stopBarcodeScanner();
                }
            });
        }
        
        // 停止条形码扫描
        function stopBarcodeScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
                startScannerBtn.style.display = 'inline-block';
                stopScannerBtn.style.display = 'none';
            }
        }
        
        // 显示登录区域
        function showLoginSection() {
            loginSection.style.display = 'flex';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'none';
            userIdInput.value = '';
        }
        
        // 显示用户仪表盘
        function showUserDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'block';
            adminDashboard.style.display = 'none';
            
            // 更新用户信息 - 修复等级显示问题
            document.getElementById('dashboardUserName').textContent = currentUser.name;
            document.getElementById('dashboardUserId').textContent = currentUser.id;
            document.getElementById('dashboardUserBarcode').textContent = currentUser.barcodeCode;
            document.getElementById('dashboardUserPoints').textContent = currentUser.points;
            document.getElementById('dashboardUserTotalPoints').textContent = currentUser.totalPoints;
            document.getElementById('dashboardUserTier').textContent = currentUser.tier;
            document.getElementById('dashboardUserTier').className = 'user-tier ' + getTierClass(currentUser.tier);
            
            // 更新等级信息 - 修复等级计算
            const currentLevel = calculateUserLevel(currentUser.totalPoints);
            const levelClass = getLevelClass(currentLevel);
            document.getElementById('dashboardUserLevel').textContent = `等級 ${currentLevel}`;
            document.getElementById('dashboardUserLevel').className = `level-badge ${levelClass}`;
            
            // 更新成就称号
            const achievementTitle = updateUserAchievementTitle(currentUser);
            document.getElementById('dashboardUserAchievementTitle').textContent = achievementTitle;
            
            // 更新等级进度 - 修复为250积分升一级
            updateLevelProgress(currentUser);
            
            // 生成用户条形码 - 添加延迟
            setTimeout(() => {
                generateBarcode(currentUser.barcodeCode, userBarcodeDisplay);
            }, 100);
            
            // 重新渲染奖品列表
            renderPrizes();
            
            // 更新成就统计
            updateAchievementStats();
            
            // 更新最后活动时间
            currentUser.lastActive = new Date().getTime();
            saveDataToStorage();
        }
        
        // 更新用户等级进度 - 修复为250积分升一级
        function updateLevelProgress(user) {
            const progress = getLevelProgress(user.totalPoints);
            
            levelProgressText.textContent = `${progress.pointsInLevel}/${systemConfig.levelIncrement || 250} 積分 (等級 ${progress.currentLevel})`;
            levelProgressFill.style.width = `${progress.progressPercentage}%`;
            userLevelProgress.style.display = 'block';
        }
        
        // 显示管理员仪表盘
        function showAdminDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'block';
        }
        
        // 渲染奖品列表（用户界面）
        function renderPrizes() {
            prizesGrid.innerHTML = '';
            
            prizes.forEach(prize => {
                const prizeCard = document.createElement('div');
                prizeCard.className = 'prize-card';
                
                const canAfford = currentUser && currentUser.points >= prize.points;
                
                prizeCard.innerHTML = `
                    <div class="prize-image">
                        <i class="fas ${prize.icon}"></i>
                    </div>
                    <div class="prize-name">${prize.name}</div>
                    <div class="prize-points">${prize.points} 积分</div>
                    <button class="btn ${canAfford ? '' : 'disabled'}" 
                            ${canAfford ? '' : 'disabled'}
                            onclick="openRedeemConfirm('${prize.id}')">
                        ${canAfford ? '立即兌換' : '積分不足'}
                    </button>
                `;
                
                prizesGrid.appendChild(prizeCard);
            });
        }
        
        // 打开兑换确认页面
        function openRedeemConfirm(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            
            if (!prize || !currentUser) return;
            
            // 设置当前兑换奖品ID
            currentRedeemPrizeId = prizeId;
            
            // 更新确认页面信息
            confirmPrizeName.textContent = prize.name;
            confirmPrizePoints.textContent = prize.points;
            confirmPrizeIcon.className = `fas ${prize.icon}`;
            confirmUserCurrentPoints.textContent = currentUser.points;
            
            // 计算兑换后积分
            const afterPoints = currentUser.points - prize.points;
            confirmUserAfterPoints.textContent = afterPoints;
            
            // 根据积分是否足够设置样式
            if (afterPoints >= 0) {
                confirmUserAfterPoints.className = 'balance-after balance-positive';
            } else {
                confirmUserAfterPoints.className = 'balance-after balance-negative';
            }
            
            // 显示确认模态框
            redeemConfirmModal.style.display = 'flex';
        }
        
        // 确认兑换奖品
        function redeemPrizeConfirmed(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            
            if (currentUser.points >= prize.points) {
                currentUser.points -= prize.points;
                
                // 增加奖品兑换计数
                if (prize.exchangeCount === undefined) {
                    prize.exchangeCount = 0;
                }
                prize.exchangeCount++;
                
                // 记录积分变更历史
                pointsHistory.push({
                    userId: currentUser.id,
                    timestamp: new Date().getTime(),
                    pointsChange: -prize.points,
                    reason: `兌換獎品：${prize.name}`
                });
                
                // 更新最后活动时间
                currentUser.lastActive = new Date().getTime();
                
                // 检查成就
                checkAchievements(currentUser);
                
                // 保存数据
                saveDataToStorage();
                
                // 关闭确认模态框
                redeemConfirmModal.style.display = 'none';
                
                // 立即刷新积分显示
                document.getElementById('dashboardUserPoints').textContent = currentUser.points;
                updateLevelProgress(currentUser);
                renderPrizes();
                showNotification(`成功兑换 ${prize.name}！`, 'success');
                
                // 如果用户在成就页面，刷新成就显示
                if (document.getElementById('achievements-tab').classList.contains('active')) {
                    renderAchievements();
                    updateAchievementStats();
                }
            } else {
                showNotification('積分不足，无法兑换該獎品', 'error');
                redeemConfirmModal.style.display = 'none';
            }
        }
        
        // 渲染用户表格 - 修复：添加撤销管理员选项，禁止自己删除自己
        function renderUsersTable(searchTerm = '') {
            usersTableBody.innerHTML = '';
            
            let filteredUsers = users;
            
            if (searchTerm) {
                filteredUsers = users.filter(user => 
                    user.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.barcodeCode.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                const levelClass = getLevelClass(user.level);
                
                // 判断是否为当前登录的管理员
                const isCurrentAdmin = (user.id === currentAdminId);
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.barcodeCode}</td>
                    <td>${user.points}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                    <td><span class="level-badge ${levelClass}">${user.level}</span></td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="selectUser('${user.id}')">选择</button>
                        ${!user.isAdmin ? 
                            `<button class="action-btn" style="background: #f39c12;" onclick="promoteUser('${user.id}')">升级为管理員</button>` : 
                            `<button class="action-btn" style="background: #9b59b6;" onclick="demoteUser('${user.id}')" ${isCurrentAdmin ? 'disabled' : ''}>撤銷管理員</button>`
                        }
                        <button class="action-btn" style="background: #e74c3c;" onclick="deleteUser('${user.id}')" ${isCurrentAdmin ? 'disabled' : ''}>移除人員</button>
                    </td>
                `;
                
                usersTableBody.appendChild(row);
            });
            
            updateUserStats();
        }
        
        // 渲染奖品表格（管理员界面）
        function renderPrizesTable() {
            prizesTableBody.innerHTML = '';
            
            prizes.forEach(prize => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${prize.id}</td>
                    <td>${prize.name}</td>
                    <td>${prize.points}</td>
                    <td><i class="fas ${prize.icon}"></i> ${prize.icon}</td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="editPrize('${prize.id}')">编辑</button>
                        <button class="action-btn" style="background: #e74c3c;" onclick="deletePrize('${prize.id}')">移除人員</button>
                    </td>
                `;
                
                prizesTableBody.appendChild(row);
            });
        }
        
        // 渲染用户积分历史
        function renderUserHistory() {
            const userHistoryContent = document.getElementById('userHistoryContent');
            userHistoryContent.innerHTML = '';
            
            // 获取当前用户的历史记录
            const userHistory = pointsHistory
                .filter(record => record.userId === currentUser.id)
                .sort((a, b) => b.timestamp - a.timestamp);
            
            if (userHistory.length === 0) {
                userHistoryContent.innerHTML = '<p>暂無積分歷史紀錄</p>';
                return;
            }
            
            userHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                userHistoryContent.appendChild(historyItem);
            });
        }
        
        // 渲染管理员查看的积分历史
        function renderAdminHistory(searchTerm = '') {
            const adminHistoryContent = document.getElementById('adminHistoryContent');
            adminHistoryContent.innerHTML = '';
            
            let filteredHistory = pointsHistory;
            
            // 如果提供了搜索条件，过滤历史记录
            if (searchTerm) {
                // 查找匹配的用户
                const matchedUsers = users.filter(u => 
                    u.id.includes(searchTerm) || 
                    u.name.includes(searchTerm) || 
                    u.barcodeCode.includes(searchTerm)
                );
                
                const matchedUserIds = matchedUsers.map(u => u.id);
                filteredHistory = pointsHistory.filter(record => 
                    matchedUserIds.includes(record.userId)
                );
            }
            
            // 按时间排序
            filteredHistory.sort((a, b) => b.timestamp - a.timestamp);
            
            if (filteredHistory.length === 0) {
                adminHistoryContent.innerHTML = '<p>暂無積分歷史紀錄</p>';
                return;
            }
            
            filteredHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const user = users.find(u => u.id === record.userId);
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div><strong>${user ? user.name : '未知用户'} (${record.userId})</strong></div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                adminHistoryContent.appendChild(historyItem);
            });
        }
        
        // 渲染用户排行榜 - 前三名更醒目，显示等级
        function renderUserLeaderboard() {
            userLeaderboardBody.innerHTML = '';
            
            // 获取普通用户并按累积积分排序
            const sortedUsers = users
                .filter(u => !u.isAdmin)
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            if (sortedUsers.length === 0) {
                userLeaderboardBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无用户数据</td></tr>';
                return;
            }
            
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                const levelClass = getLevelClass(user.level);
                
                // 为前三名添加特殊样式
                if (index < 3) {
                    row.className = 'top-three';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.id}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                    <td><span class="level-badge ${levelClass}">${user.level}</span></td>
                `;
                
                userLeaderboardBody.appendChild(row);
            });
        }
        
        // 渲染管理员排行榜 - 前三名更醒目，显示等级
        function renderAdminLeaderboard() {
            adminLeaderboardBody.innerHTML = '';
            
            // 获取普通用户并按累积积分排序
            const sortedUsers = users
                .filter(u => !u.isAdmin)
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            if (sortedUsers.length === 0) {
                adminLeaderboardBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无用户数据</td></tr>';
                return;
            }
            
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                const levelClass = getLevelClass(user.level);
                
                // 为前三名添加特殊样式
                if (index < 3) {
                    row.className = 'top-three';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.id}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                    <td><span class="level-badge ${levelClass}">${user.level}</span></td>
                `;
                
                adminLeaderboardBody.appendChild(row);
            });
        }
        
        // 渲染成就系统 - 已解锁的成就放在前面 - 修复成就显示问题
        function renderAchievements() {
            achievementsGrid.innerHTML = '';
            
            if (!currentUser) return;
            
            // 确保用户有成就数据
            if (!currentUser.achievements) currentUser.achievements = [];
            if (!currentUser.achievementData) currentUser.achievementData = {};
            
            // 检查并更新用户成就
            checkAchievements(currentUser);
            
            // 将成就分为已解锁和未解锁两组
            const unlockedAchievements = [];
            const lockedAchievements = [];
            
            achievements.forEach(achievement => {
                // 获取成就数据
                const achievementData = achievement.getData ? achievement.getData(currentUser) : {};
                
                // 检查是否已解锁
                const isUnlocked = achievement.condition(currentUser, achievementData);
                const progress = achievement.progress ? achievement.progress(currentUser, achievementData) : (isUnlocked ? 100 : 0);
                
                const achievementObj = {
                    achievement: achievement,
                    isUnlocked: isUnlocked,
                    progress: progress,
                    data: achievementData
                };
                
                if (isUnlocked) {
                    unlockedAchievements.push(achievementObj);
                } else {
                    lockedAchievements.push(achievementObj);
                }
            });
            
            // 先渲染已解锁的成就
            unlockedAchievements.forEach(({ achievement, isUnlocked, progress, data }) => {
                createAchievementCard(achievement, isUnlocked, progress, data);
            });
            
            // 再渲染未解锁的成就
            lockedAchievements.forEach(({ achievement, isUnlocked, progress, data }) => {
                createAchievementCard(achievement, isUnlocked, progress, data);
            });
            
            // 更新成就统计
            updateAchievementStats();
        }
        
        // 创建成就卡片
        function createAchievementCard(achievement, isUnlocked, progress, data) {
            const achievementCard = document.createElement('div');
            achievementCard.className = `achievement-card ${isUnlocked ? 'unlocked' : 'locked'}`;
            
            achievementCard.innerHTML = `
                <div class="achievement-icon">
                    <i class="fas ${achievement.icon}"></i>
                </div>
                <div class="achievement-name">${achievement.name}</div>
                <div class="achievement-description">${achievement.description}</div>
                <div class="achievement-reward">${achievement.reward}</div>
                
                ${!isUnlocked ? `
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div class="achievement-progress-text">${progress.toFixed(0)}% 完成</div>
                ` : ''}
                
                <div class="achievement-status ${isUnlocked ? 'achievement-unlocked' : 'achievement-locked'}">
                    ${isUnlocked ? '已解鎖' : '未解鎖'}
                </div>
            `;
            
            // 添加解锁动画效果
            if (isUnlocked && !currentUser.achievementData[achievement.id]) {
                achievementCard.style.animation = 'achievementUnlock 0.5s ease';
                currentUser.achievementData[achievement.id] = true;
                saveDataToStorage();
            }
            
            achievementsGrid.appendChild(achievementCard);
        }
        
        // 渲染消息列表
        function renderMessageList(filterType = 'all') {
            messageList.innerHTML = '';
            
            if (!currentUser) return;
            
            // 获取当前用户的消息
            let userMessages = messages.filter(msg => 
                msg.recipient === currentUser.id || 
                msg.recipient === 'all' || 
                msg.sender === currentUser.id
            );
            
            // 应用过滤器
            if (filterType !== 'all') {
                if (filterType === 'unread') {
                    userMessages = userMessages.filter(msg => !msg.read && msg.recipient === currentUser.id);
                } else {
                    userMessages = userMessages.filter(msg => msg.type === filterType);
                }
            }
            
            // 按时间排序（最新的在前面）
            userMessages.sort((a, b) => b.timestamp - a.timestamp);
            
            if (userMessages.length === 0) {
                messageList.innerHTML = '<div class="message-item" style="text-align: center; padding: 40px 20px; cursor: default;">暫無消息</div>';
                return;
            }
            
            userMessages.forEach(message => {
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${!message.read && message.recipient === currentUser.id ? 'unread' : ''}`;
                messageItem.setAttribute('data-id', message.id);
                
                const sender = getSenderName(message.sender);
                const date = formatDate(message.timestamp);
                const typeClass = `type-${message.type}`;
                const typeText = getMessageTypeText(message.type);
                
                // 如果是发送的消息，显示收件人
                const recipientInfo = message.sender === currentUser.id ? 
                    `給 ${getRecipientName(message.recipient)}` : '';
                
                messageItem.innerHTML = `
                    <div class="message-header">
                        <div>
                            <span class="message-type ${typeClass}">${typeText}</span>
                            <span class="message-sender">${sender} ${recipientInfo}</span>
                        </div>
                        <span class="message-date">${date}</span>
                    </div>
                    <div class="message-title">${message.title}</div>
                    <div class="message-preview">${message.content.substring(0, 100)}${message.content.length > 100 ? '...' : ''}</div>
                    <div class="message-actions">
                        <button class="btn btn-sm" onclick="viewMessageDetail('${message.id}')">查看詳情</button>
                        ${!message.read && message.recipient === currentUser.id ? 
                            `<button class="btn btn-secondary btn-sm" onclick="markMessageAsRead('${message.id}')">標記為已讀</button>` : ''}
                        ${message.recipient !== 'all' && message.sender !== currentUser.id ? 
                            `<button class="btn btn-info btn-sm" onclick="replyToMessage('${message.id}')">回覆</button>` : ''}
                    </div>
                `;
                
                messageList.appendChild(messageItem);
            });
        }
        
        // 渲染收件人列表（消息系统）
        function renderMessageRecipientList() {
            messageRecipient.innerHTML = '<option value="">-- 選擇收件人 --</option>';
            
            // 添加所有用户（包括管理员）
            users.forEach(user => {
                // 不显示自己
                if (user.id === currentUser.id) return;
                
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.id})${user.isAdmin ? ' [管理員]' : ''}`;
                messageRecipient.appendChild(option);
            });
            
            // 添加"所有用户"选项
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = '所有用户 (系統公告)';
            messageRecipient.appendChild(allOption);
        }
        
        // 获取发送者姓名
        function getSenderName(senderId) {
            if (senderId === 'system') return '系統';
            const user = users.find(u => u.id === senderId);
            return user ? user.name : '未知用戶';
        }
        
        // 获取收件人姓名
        function getRecipientName(recipientId) {
            if (recipientId === 'all') return '所有用户';
            if (recipientId === 'system') return '系統';
            const user = users.find(u => u.id === recipientId);
            return user ? user.name : '未知用戶';
        }
        
        // 获取消息类型文本
        function getMessageTypeText(type) {
            switch(type) {
                case 'announcement': return '系統公告';
                case 'feedback': return '反饋回覆';
                case 'mail': return '個人郵件';
                case 'system': return '系統消息';
                default: return '未知';
            }
        }
        
        // 发送消息
        function sendMessage() {
            const recipientId = messageRecipient.value;
            const subject = messageSubject.value.trim();
            const content = messageContent.value.trim();
            
            if (!recipientId || !subject || !content) {
                showNotification('請填寫收件人、標題和內容', 'error');
                return;
            }
            
            // 生成消息ID
            const messageId = generateMessageId();
            
            // 确定消息类型
            let messageType = 'mail';
            if (recipientId === 'all') {
                messageType = 'announcement';
            }
            
            // 创建消息对象
            const newMessage = {
                id: messageId,
                type: messageType,
                title: subject,
                content: content,
                sender: currentUser.id,
                recipient: recipientId,
                timestamp: new Date().getTime(),
                read: false,
                threadId: generateThreadId(),
                parentId: null
            };
            
            // 添加到消息列表
            messages.push(newMessage);
            saveMessagesToStorage();
            
            // 清空表单
            messageSubject.value = '';
            messageContent.value = '';
            newMessageForm.style.display = 'none';
            
            // 重新渲染消息列表
            renderMessageList('all');
            
            showNotification('消息發送成功', 'success');
        }
        
        // 查看消息详情
        function viewMessageDetail(messageId) {
            const message = messages.find(m => m.id === messageId);
            
            if (!message) return;
            
            // 标记为已读（如果是收件人）
            if (message.recipient === currentUser.id && !message.read) {
                message.read = true;
                saveMessagesToStorage();
            }
            
            const sender = getSenderName(message.sender);
            const recipient = getRecipientName(message.recipient);
            const date = formatDate(message.timestamp);
            const typeText = getMessageTypeText(message.type);
            
            // 获取对话线程中的所有消息
            const threadMessages = message.threadId ? 
                messages.filter(m => m.threadId === message.threadId).sort((a, b) => a.timestamp - b.timestamp) : 
                [message];
            
            let threadHtml = '';
            
            threadMessages.forEach(threadMsg => {
                const isSent = threadMsg.sender === currentUser.id;
                const threadSender = getSenderName(threadMsg.sender);
                const threadDate = formatDate(threadMsg.timestamp);
                
                threadHtml += `
                    <div class="thread-item ${isSent ? 'sent' : 'received'}">
                        <div class="thread-header">
                            <div class="thread-sender">${threadSender}</div>
                            <div class="thread-date">${threadDate}</div>
                        </div>
                        <div class="thread-content">${threadMsg.content.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            });
            
            messageDetailContent.innerHTML = `
                <h4>${message.title}</h4>
                <div style="margin: 15px 0; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                    <div style="margin-bottom: 10px;">
                        <p><strong>發件人:</strong> ${sender}</p>
                        <p><strong>收件人:</strong> ${recipient}</p>
                        <p><strong>發送時間:</strong> ${date}</p>
                        <p><strong>類型:</strong> ${typeText}</p>
                    </div>
                </div>
                
                <h5>對話記錄</h5>
                <div class="message-thread">
                    ${threadHtml}
                </div>
                
                ${message.recipient !== 'all' ? `
                    <div style="margin-top: 20px;">
                        <button class="btn btn-info" onclick="replyToMessage('${message.id}')">回覆此消息</button>
                    </div>
                ` : ''}
            `;
            
            messageDetailModal.style.display = 'flex';
            
            // 重新渲染消息列表以更新未读状态
            renderMessageList('all');
        }
        
        // 回复消息
        function replyToMessage(messageId) {
            const message = messages.find(m => m.id === messageId);
            
            if (message) {
                const sender = getSenderName(message.sender);
                replyMessageRecipient.value = `${sender} (${message.sender})`;
                replyMessageSubject.value = `回覆: ${message.title}`;
                replyMessageContent.value = '';
                replyMessageModal.style.display = 'flex';
                
                // 存储当前消息ID
                replyMessageModal.setAttribute('data-message-id', messageId);
            }
        }
        
        // 发送回复消息
        function sendReplyMessage() {
            const originalMessageId = replyMessageModal.getAttribute('data-message-id');
            const subject = replyMessageSubject.value.trim();
            const content = replyMessageContent.value.trim();
            
            if (!subject || !content) {
                showNotification('請填寫標題和內容', 'error');
                return;
            }
            
            const originalMessage = messages.find(m => m.id === originalMessageId);
            if (!originalMessage) return;
            
            // 生成消息ID
            const messageId = generateMessageId();
            
            // 确定收件人（回复给原发送者）
            const recipient = originalMessage.sender;
            
            // 创建回复消息对象
            const replyMessage = {
                id: messageId,
                type: 'mail',
                title: subject,
                content: content,
                sender: currentUser.id,
                recipient: recipient,
                timestamp: new Date().getTime(),
                read: false,
                threadId: originalMessage.threadId || generateThreadId(),
                parentId: originalMessageId
            };
            
            // 添加到消息列表
            messages.push(replyMessage);
            saveMessagesToStorage();
            
            // 关闭模态框
            replyMessageModal.style.display = 'none';
            
            // 更新显示
            viewMessageDetail(originalMessageId);
            renderMessageList('all');
            
            showNotification('回覆已發送', 'success');
        }
        
        // 标记消息为已读
        function markMessageAsRead(messageId) {
            const message = messages.find(m => m.id === messageId);
            
            if (message && message.recipient === currentUser.id) {
                message.read = true;
                saveMessagesToStorage();
                renderMessageList('all');
                showNotification('消息已標記為已讀', 'success');
            }
        }
        
        // 标记所有消息为已读
        function markAllMessagesAsRead() {
            let count = 0;
            
            messages.forEach(message => {
                if (message.recipient === currentUser.id && !message.read) {
                    message.read = true;
                    count++;
                }
            });
            
            if (count > 0) {
                saveMessagesToStorage();
                renderMessageList('all');
                showNotification(`已標記 ${count} 條消息為已讀`, 'success');
            } else {
                showNotification('沒有未讀消息', 'info');
            }
        }
        
        // 检查未读消息
        function checkUnreadMessages() {
            if (!currentUser) return 0;
            
            const unreadCount = messages.filter(msg => 
                (msg.recipient === currentUser.id || msg.recipient === 'all') && 
                !msg.read
            ).length;
            
            // 在消息选项卡上显示未读计数
            const messagesTab = document.querySelector('[data-tab="messages"]');
            if (messagesTab) {
                if (unreadCount > 0) {
                    messagesTab.innerHTML = `消息欄 <span class="badge">${unreadCount}</span>`;
                } else {
                    messagesTab.innerHTML = '消息欄';
                }
            }
            
            return unreadCount;
        }
        
        // 渲染管理员消息列表
        function renderAdminMessages() {
            adminMessageList.innerHTML = '';
            
            const searchTerm = document.getElementById('searchAdminMessages').value.toLowerCase();
            const typeFilter = messageTypeFilter.value;
            
            let filteredMessages = messages;
            
            // 应用搜索过滤
            if (searchTerm) {
                filteredMessages = filteredMessages.filter(msg => 
                    msg.title.toLowerCase().includes(searchTerm) || 
                    msg.content.toLowerCase().includes(searchTerm) ||
                    msg.sender.toLowerCase().includes(searchTerm) ||
                    msg.recipient.toLowerCase().includes(searchTerm)
                );
            }
            
            // 应用类型过滤
            if (typeFilter !== 'all') {
                filteredMessages = filteredMessages.filter(msg => msg.type === typeFilter);
            }
            
            // 按时间排序
            filteredMessages.sort((a, b) => b.timestamp - a.timestamp);
            
            if (filteredMessages.length === 0) {
                adminMessageList.innerHTML = '<div class="message-item" style="text-align: center; padding: 40px 20px; cursor: default;">暫無消息</div>';
                return;
            }
            
            filteredMessages.forEach(message => {
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${!message.read ? 'unread' : ''}`;
                
                const sender = getSenderName(message.sender);
                const recipient = getRecipientName(message.recipient);
                const date = formatDate(message.timestamp);
                const typeClass = `type-${message.type}`;
                const typeText = getMessageTypeText(message.type);
                
                messageItem.innerHTML = `
                    <div class="message-header">
                        <div>
                            <span class="message-type ${typeClass}">${typeText}</span>
                            <span class="message-sender">${sender} → ${recipient}</span>
                        </div>
                        <span class="message-date">${date}</span>
                    </div>
                    <div class="message-title">${message.title}</div>
                    <div class="message-preview">${message.content.substring(0, 100)}${message.content.length > 100 ? '...' : ''}</div>
                    <div class="message-actions">
                        <button class="btn btn-sm" onclick="viewAdminMessageDetail('${message.id}')">查看詳情</button>
                        ${!message.read ? 
                            `<button class="btn btn-secondary btn-sm" onclick="markAdminMessageAsRead('${message.id}')">標記為已讀</button>` : ''}
                        <button class="btn btn-danger btn-sm" onclick="deleteMessage('${message.id}')">刪除</button>
                    </div>
                `;
                
                adminMessageList.appendChild(messageItem);
            });
        }
        
        // 查看管理员消息详情
        function viewAdminMessageDetail(messageId) {
            const message = messages.find(m => m.id === messageId);
            
            if (!message) return;
            
            const sender = getSenderName(message.sender);
            const recipient = getRecipientName(message.recipient);
            const date = formatDate(message.timestamp);
            const typeText = getMessageTypeText(message.type);
            
            messageDetailContent.innerHTML = `
                <h4>${message.title}</h4>
                <div style="margin: 15px 0; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                    <div style="margin-bottom: 10px;">
                        <p><strong>發件人:</strong> ${sender}</p>
                        <p><strong>收件人:</strong> ${recipient}</p>
                        <p><strong>發送時間:</strong> ${date}</p>
                        <p><strong>類型:</strong> ${typeText}</p>
                        <p><strong>消息ID:</strong> ${message.id}</p>
                        ${message.threadId ? `<p><strong>對話ID:</strong> ${message.threadId}</p>` : ''}
                    </div>
                    <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 5px; margin-top: 15px;">
                        ${message.content.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            
            messageDetailModal.style.display = 'flex';
        }
        
        // 标记管理员消息为已读
        function markAdminMessageAsRead(messageId) {
            const message = messages.find(m => m.id === messageId);
            
            if (message) {
                message.read = true;
                saveMessagesToStorage();
                renderAdminMessages();
                showNotification('消息已標記為已讀', 'success');
            }
        }
        
        // 删除消息
        function deleteMessage(messageId) {
            if (confirm('確定要刪除此消息嗎？此操作不可恢復！')) {
                messages = messages.filter(m => m.id !== messageId);
                saveMessagesToStorage();
                renderAdminMessages();
                showNotification('消息已刪除', 'success');
            }
        }
        
        // 导出消息数据
        function exportMessagesData() {
            const dataStr = JSON.stringify(messages, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'messages_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('消息數據導出成功', 'success');
        }
        
        // 清理旧消息
        function clearOldMessages() {
            if (confirm('確定要清理30天前的舊消息嗎？此操作不可恢復！')) {
                const now = new Date().getTime();
                const thirtyDaysAgo = now - (30 * 24 * 60 * 60 * 1000);
                
                const initialCount = messages.length;
                messages = messages.filter(msg => msg.timestamp >= thirtyDaysAgo);
                
                const removedCount = initialCount - messages.length;
                saveMessagesToStorage();
                renderAdminMessages();
                showNotification(`已清理 ${removedCount} 條舊消息`, 'success');
            }
        }
        
        // 渲染通知偏好设置
        function renderNotificationPreferences() {
            notificationPreferences.innerHTML = '';
            
            if (!currentUser) return;
            
            // 确保用户有通知偏好设置
            if (!currentUser.notificationPreferences) {
                currentUser.notificationPreferences = JSON.parse(JSON.stringify(systemConfig.notificationPrefs));
                saveDataToStorage();
            }
            
            const preferences = [
                { id: 'achievementUnlock', label: '成就解鎖通知', description: '當您解鎖新成就時接收通知' },
                { id: 'pointsChange', label: '積分變動通知', description: '當您的積分發生變動時接收通知' },
                { id: 'newPrizeAvailable', label: '新獎品通知', description: '當有新獎品上架時接收通知' },
                { id: 'systemAnnouncement', label: '系統公告通知', description: '當有新的系統公告時接收通知' },
                { id: 'levelUp', label: '等級提升通知', description: '當您提升等級時接收通知' },
                { id: 'newMessage', label: '新消息通知', description: '當收到新消息時接收通知' }
            ];
            
            preferences.forEach(pref => {
                const isEnabled = currentUser.notificationPreferences[pref.id] !== false;
                
                const prefItem = document.createElement('div');
                prefItem.className = 'preference-item';
                prefItem.innerHTML = `
                    <div class="preference-info">
                        <h5>${pref.label}</h5>
                        <p>${pref.description}</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pref_${pref.id}" ${isEnabled ? 'checked' : ''}>
                        <span class="toggle-slider"></span>
                    </label>
                `;
                
                notificationPreferences.appendChild(prefItem);
            });
        }
        
        // 保存通知偏好设置
        function saveNotificationPreferences() {
            if (!currentUser) return;
            
            // 收集所有偏好设置
            const preferences = ['achievementUnlock', 'pointsChange', 'newPrizeAvailable', 'systemAnnouncement', 'levelUp', 'newMessage'];
            
            preferences.forEach(prefId => {
                const checkbox = document.getElementById(`pref_${prefId}`);
                if (checkbox) {
                    currentUser.notificationPreferences[prefId] = checkbox.checked;
                }
            });
            
            // 保存数据
            saveDataToStorage();
            
            showNotification('通知偏好設定已保存', 'success');
        }
        
        // 渲染段位饼图 - 带动画效果，更圆润
        function renderTierPieChartWithAnimation(canvasElement, legendElement) {
            // 如果已有动画在进行，取消它
            if (pieChartAnimations[canvasElement.id]) {
                cancelAnimationFrame(pieChartAnimations[canvasElement.id]);
                delete pieChartAnimations[canvasElement.id];
            }
            
            // 统计各段位用户数量
            const tierCounts = {};
            systemConfig.tierThresholds.forEach(tier => {
                tierCounts[tier.name] = 0;
            });
            
            users.filter(u => !u.isAdmin).forEach(user => {
                tierCounts[user.tier]++;
            });
            
            // 过滤掉数量为0的段位
            const filteredTiers = systemConfig.tierThresholds.filter(tier => tierCounts[tier.name] > 0);
            
            // 计算总数
            const totalUsers = users.filter(u => !u.isAdmin).length;
            
            // 生成图例
            legendElement.innerHTML = '';
            filteredTiers.forEach(tier => {
                const percentage = totalUsers > 0 ? ((tierCounts[tier.name] / totalUsers) * 100).toFixed(1) : 0;
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${tier.color};"></div>
                    <span>${tier.name}: ${tierCounts[tier.name]}人 (${percentage}%)</span>
                `;
                legendElement.appendChild(legendItem);
            });
            
            const ctx = canvasElement.getContext('2d');
            const width = canvasElement.width;
            const height = canvasElement.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 * 0.8;
            
            // 清除画布
            ctx.clearRect(0, 0, width, height);
            
            // 如果没有数据，显示提示
            if (totalUsers === 0) {
                ctx.fillStyle = '#ccc';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', centerX, centerY);
                return;
            }
            
            // 计算每个扇形的起始和结束角度
            let startAngle = -Math.PI / 2; // 从12点钟方向开始
            const slices = filteredTiers.map(tier => {
                const sliceAngle = (2 * Math.PI * tierCounts[tier.name]) / totalUsers;
                const slice = {
                    tier: tier,
                    startAngle: startAngle,
                    endAngle: startAngle + sliceAngle,
                    color: tier.color
                };
                startAngle += sliceAngle;
                return slice;
            });
            
            // 动画参数
            const duration = 1500; // 动画持续1500毫秒
            let startTime = null;
            
            // 动画函数
            function animate(currentTime) {
                if (!startTime) startTime = currentTime;
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1); // 0到1
                
                // 当前角度从0到2PI
                const currentAngle = progress * 2 * Math.PI;
                
                // 清除画布
                ctx.clearRect(0, 0, width, height);
                
                // 绘制每个扇形
                slices.forEach(slice => {
                    // 如果当前角度大于这个扇形的起始角度，则绘制
                    if (currentAngle > slice.startAngle + Math.PI / 2) {
                        const start = slice.startAngle;
                        const end = Math.min(currentAngle - Math.PI / 2, slice.endAngle);
                        
                        if (end > start) {
                            ctx.beginPath();
                            ctx.moveTo(centerX, centerY);
                            ctx.arc(centerX, centerY, radius, start, end);
                            ctx.closePath();
                            ctx.fillStyle = slice.color;
                            ctx.fill();
                            
                            // 绘制分隔线
                            ctx.strokeStyle = 'white';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    }
                });
                
                // 如果动画未完成，继续
                if (progress < 1) {
                    pieChartAnimations[canvasElement.id] = requestAnimationFrame(animate);
                } else {
                    // 动画完成，绘制中心圆和文字
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius * 0.5, 0, 2 * Math.PI);
                    ctx.fillStyle = 'white';
                    ctx.fill();
                    
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('段位分布', centerX, centerY - 8);
                    ctx.font = '14px Arial';
                    ctx.fillText(`${totalUsers}人`, centerX, centerY + 10);
                    
                    // 动画完成，清除动画ID
                    delete pieChartAnimations[canvasElement.id];
                }
            }
            
            // 启动动画
            pieChartAnimations[canvasElement.id] = requestAnimationFrame(animate);
        }
        
        // 选择用户
        function selectUser(userId) {
            const user = users.find(u => u.id === userId);
            document.getElementById('searchUser').value = user.id;
        }
        
        // 升级用户为管理员
        function promoteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.isAdmin = true;
                
                // 保存数据
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification(`已将 ${user.name} 升級為管理員`, 'success');
            }
        }
        
        // 撤销管理员权限
        function demoteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                // 检查是否是当前登录的管理员
                if (user.id === currentAdminId) {
                    showNotification('不能撤銷自己的管理員權限', 'error');
                    return;
                }
                
                user.isAdmin = false;
                
                // 保存数据
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification(`已撤銷 ${user.name} 的管理員權限`, 'success');
            }
        }
        
        // 删除用户 - 添加检查：禁止删除自己
        function deleteUser(userId) {
            // 检查是否是当前登录的管理员
            if (userId === currentAdminId) {
                showNotification('不能刪除自己', 'error');
                return;
            }
            
            if (confirm('确定要删除这个用户吗？此操作不可撤銷。')) {
                users = users.filter(u => u.id !== userId);
                
                // 保存数据
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification('用户已删除', 'success');
            }
        }
        
        // 编辑奖品
        function editPrize(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            if (prize) {
                document.getElementById('editPrizeId').value = prize.id;
                document.getElementById('editPrizeName').value = prize.name;
                document.getElementById('editPrizePoints').value = prize.points;
                document.getElementById('editPrizeIcon').value = prize.icon;
                
                editPrizeModal.style.display = 'flex';
            }
        }
        
        // 删除奖品
        function deletePrize(prizeId) {
            if (confirm('确定要删除这个獎品吗？此操作不可撤銷。')) {
                prizes = prizes.filter(p => p.id !== prizeId);
                
                // 保存数据
                saveDataToStorage();
                
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                showNotification('獎品已删除', 'success');
            }
        }
        
        // 更新用户统计信息 - 使用累积积分
        function updateUserStats() {
            const totalUsers = users.filter(u => !u.isAdmin).length;
            const totalPoints = users.filter(u => !u.isAdmin).reduce((sum, user) => sum + user.points, 0);
            
            // 使用累积积分统计各段位用户数量
            const activeUsers = users.filter(u => !u.isAdmin && u.totalPoints >= 1500).length;
            const activeUser4 = users.filter(u => !u.isAdmin && u.totalPoints >= 1200 && u.totalPoints < 1500).length;
            const activeUser3 = users.filter(u => !u.isAdmin && u.totalPoints >= 900 && u.totalPoints < 1200).length;
            const activeUser2 = users.filter(u => !u.isAdmin && u.totalPoints >= 600 && u.totalPoints < 900).length;
            const activeUser1 = users.filter(u => !u.isAdmin && u.totalPoints >= 300 && u.totalPoints < 600).length;
            const activeUser0 = users.filter(u => !u.isAdmin && u.totalPoints < 300).length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('activeUser4').textContent = activeUser4;
            document.getElementById('activeUser3').textContent = activeUser3;
            document.getElementById('activeUser2').textContent = activeUser2;
            document.getElementById('activeUser1').textContent = activeUser1;
            document.getElementById('activeUser0').textContent = activeUser0;
        }
        
        // 更新系统统计信息
        function updateSystemStats() {
            document.getElementById('systemUsers').textContent = users.filter(u => !u.isAdmin).length;
            document.getElementById('systemPrizes').textContent = prizes.length;
            document.getElementById('systemHistory').textContent = pointsHistory.length;
            document.getElementById('systemAdmins').textContent = users.filter(u => u.isAdmin).length;
            document.getElementById('systemMessages').textContent = messages.length;
            
            updateUserStats();
        }
        
        // 更新管理员统计信息
        function updateAdminStats() {
            // 更新基本统计
            const totalExchanges = pointsHistory.filter(h => h.pointsChange < 0).length;
            const avgPoints = users.filter(u => !u.isAdmin).length > 0 
                ? Math.round(users.filter(u => !u.isAdmin).reduce((sum, user) => sum + user.points, 0) / users.filter(u => !u.isAdmin).length)
                : 0;
            
            // 今日活跃用户（24小时内）
            const now = new Date().getTime();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            const activeToday = users.filter(u => !u.isAdmin && u.lastActive >= oneDayAgo).length;
            
            // 找出兑换王（兑换次数最多的用户）
            const exchangeCounts = {};
            pointsHistory.filter(h => h.pointsChange < 0).forEach(record => {
                exchangeCounts[record.userId] = (exchangeCounts[record.userId] || 0) + 1;
            });
            
            let topExchanger = '無';
            let maxExchanges = 0;
            
            Object.keys(exchangeCounts).forEach(userId => {
                if (exchangeCounts[userId] > maxExchanges) {
                    maxExchanges = exchangeCounts[userId];
                    const user = users.find(u => u.id === userId);
                    if (user) {
                        topExchanger = `${user.name} (${maxExchanges}次)`;
                    }
                }
            });
            
            // 更新显示
            statTotalExchanges.textContent = totalExchanges;
            statAvgPoints.textContent = avgPoints;
            statActiveToday.textContent = activeToday;
            statTopExchanger.textContent = topExchanger;
            
            // 更新图表
            renderPointsTrendChart();
            renderPrizesChart();
            renderRecentActivities();
            renderUserActivityStats();
        }
        
        // 渲染积分变动趋势图
        function renderPointsTrendChart() {
            const ctx = pointsTrendChart.getContext('2d');
            
            // 销毁现有图表
            if (charts.pointsTrendChart) {
                charts.pointsTrendChart.destroy();
            }
            
            // 获取最近7天的数据
            const now = new Date();
            const labels = [];
            const data = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = `${date.getMonth()+1}/${date.getDate()}`;
                labels.push(dateStr);
                
                // 计算当天的积分变动总量
                const dayStart = new Date(date);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(date);
                dayEnd.setHours(23, 59, 59, 999);
                
                const dayPoints = pointsHistory
                    .filter(h => h.timestamp >= dayStart.getTime() && h.timestamp <= dayEnd.getTime())
                    .reduce((sum, h) => sum + h.pointsChange, 0);
                
                data.push(dayPoints);
            }
            
            charts.pointsTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '每日積分變動',
                        data: data,
                        borderColor: 'rgba(37, 117, 252, 1)',
                        backgroundColor: 'rgba(37, 117, 252, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '積分變動'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            }
                        }
                    }
                }
            });
        }
        
        // 渲染奖品兑换统计图
        function renderPrizesChart() {
            const ctx = prizesChart.getContext('2d');
            
            // 销毁现有图表
            if (charts.prizesChart) {
                charts.prizesChart.destroy();
            }
            
            // 获取奖品兑换数据
            const prizeNames = prizes.map(p => p.name);
            const exchangeCounts = prizes.map(p => p.exchangeCount || 0);
            
            // 生成颜色数组
            const backgroundColors = [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)'
            ];
            
            charts.prizesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: prizeNames,
                    datasets: [{
                        label: '兌換次數',
                        data: exchangeCounts,
                        backgroundColor: backgroundColors.slice(0, prizeNames.length),
                        borderColor: backgroundColors.map(c => c.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: '兌換次數'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '獎品名稱'
                            }
                        }
                    }
                }
            });
        }
        
        // 渲染最近活动
        function renderRecentActivities() {
            recentActivities.innerHTML = '';
            
            // 获取最近5条活动
            const recentHistory = [...pointsHistory]
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 5);
            
            if (recentHistory.length === 0) {
                recentActivities.innerHTML = '<li>暂无最近活动</li>';
                return;
            }
            
            recentHistory.forEach(record => {
                const user = users.find(u => u.id === record.userId);
                const userName = user ? user.name : '未知用户';
                const reason = record.reason;
                const pointsChange = record.pointsChange;
                const time = formatTimeAgo(record.timestamp);
                
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${userName} ${reason}</span>
                    <span class="stats-value">${pointsChange > 0 ? '+' : ''}${pointsChange}</span>
                `;
                li.title = `${userName} ${reason} (${time})`;
                
                recentActivities.appendChild(li);
            });
        }
        
        // 渲染用户活跃度统计
        function renderUserActivityStats() {
            userActivityStats.innerHTML = '';
            
            const now = new Date().getTime();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            const sevenDaysAgo = now - (7 * 24 * 60 * 60 * 1000);
            const thirtyDaysAgo = now - (30 * 24 * 60 * 60 * 1000);
            
            const activeToday = users.filter(u => !u.isAdmin && u.lastActive >= oneDayAgo).length;
            const active7Days = users.filter(u => !u.isAdmin && u.lastActive >= sevenDaysAgo).length;
            const active30Days = users.filter(u => !u.isAdmin && u.lastActive >= thirtyDaysAgo).length;
            const totalUsers = users.filter(u => !u.isAdmin).length;
            
            const stats = [
                { label: '今日活躍', value: activeToday, total: totalUsers },
                { label: '7日內活躍', value: active7Days, total: totalUsers },
                { label: '30日內活躍', value: active30Days, total: totalUsers },
                { label: '總用戶數', value: totalUsers, total: totalUsers }
            ];
            
            stats.forEach(stat => {
                const li = document.createElement('li');
                const percentage = totalUsers > 0 ? Math.round((stat.value / stat.total) * 100) : 0;
                
                li.innerHTML = `
                    <span>${stat.label}</span>
                    <span class="stats-value">${stat.value} (${percentage}%)</span>
                `;
                
                userActivityStats.appendChild(li);
            });
        }
        
        // 生成详细统计报告
        function generateDetailedStatsReport() {
            const now = new Date();
            const reportDate = formatDate(now.getTime());
            
            // 计算统计数据
            const totalUsers = users.filter(u => !u.isAdmin).length;
            const totalPoints = users.filter(u => !u.isAdmin).reduce((sum, user) => sum + user.points, 0);
            const totalExchanges = pointsHistory.filter(h => h.pointsChange < 0).length;
            const avgPoints = totalUsers > 0 ? Math.round(totalPoints / totalUsers) : 0;
            
            // 用户等级分布
            const levelDistribution = {};
            users.filter(u => !u.isAdmin).forEach(user => {
                levelDistribution[user.level] = (levelDistribution[user.level] || 0) + 1;
            });
            
            // 段位分布
            const tierDistribution = {};
            users.filter(u => !u.isAdmin).forEach(user => {
                tierDistribution[user.tier] = (tierDistribution[user.tier] || 0) + 1;
            });
            
            // 热门奖品
            const popularPrizes = [...prizes]
                .filter(p => p.exchangeCount > 0)
                .sort((a, b) => b.exchangeCount - a.exchangeCount)
                .slice(0, 3);
            
            // 消息统计
            const messageStats = {
                total: messages.length,
                announcements: messages.filter(m => m.type === 'announcement').length,
                mails: messages.filter(m => m.type === 'mail').length,
                feedback: messages.filter(m => m.type === 'feedback').length,
                unread: messages.filter(m => !m.read).length
            };
            
            // 生成报告文本
            let reportText = `明馬二樓積分系統統計報告\n`;
            reportText += `生成時間: ${reportDate}\n\n`;
            reportText += `=== 基本統計 ===\n`;
            reportText += `總用戶數: ${totalUsers}\n`;
            reportText += `總積分: ${totalPoints}\n`;
            reportText += `平均積分: ${avgPoints}\n`;
            reportText += `總兌換次數: ${totalExchanges}\n\n`;
            
            reportText += `=== 段位分布 ===\n`;
            Object.keys(tierDistribution).forEach(tier => {
                const percentage = Math.round((tierDistribution[tier] / totalUsers) * 100) || 0;
                reportText += `${tier}: ${tierDistribution[tier]}人 (${percentage}%)\n`;
            });
            
            reportText += `\n=== 等級分布 ===\n`;
            Object.keys(levelDistribution).sort((a, b) => a - b).forEach(level => {
                const percentage = Math.round((levelDistribution[level] / totalUsers) * 100) || 0;
                reportText += `等級 ${level}: ${levelDistribution[level]}人 (${percentage}%)\n`;
            });
            
            if (popularPrizes.length > 0) {
                reportText += `\n=== 熱門獎品 ===\n`;
                popularPrizes.forEach(prize => {
                    reportText += `${prize.name}: ${prize.exchangeCount}次兌換\n`;
                });
            }
            
            reportText += `\n=== 消息統計 ===\n`;
            reportText += `總消息數: ${messageStats.total}\n`;
            reportText += `系統公告: ${messageStats.announcements}\n`;
            reportText += `個人郵件: ${messageStats.mails}\n`;
            reportText += `反饋回覆: ${messageStats.feedback}\n`;
            reportText += `未讀消息: ${messageStats.unread}\n`;
            
            reportText += `\n=== 系統信息 ===\n`;
            reportText += `獎品總數: ${prizes.length}\n`;
            reportText += `歷史紀錄總數: ${pointsHistory.length}\n`;
            reportText += `管理員數量: ${users.filter(u => u.isAdmin).length}\n`;
            reportText += `公告歷史數量: ${announcementsHistory.length}\n`;
            
            // 创建报告文件
            const dataStr = reportText;
            const dataBlob = new Blob([dataStr], {type: 'text/plain'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `積分系統統計報告_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('統計報告已生成並下載', 'success');
        }
        
        // 发布系统公告
        function publishAnnouncement() {
            const title = announcementTitle.value.trim();
            const content = announcementContentEditor.value.trim();
            const priority = announcementPriority.value;
            const expiryDays = parseInt(announcementExpiry.value) || 7;
            
            if (!content) {
                showNotification('請輸入公告內容', 'error');
                return;
            }
            
            const now = new Date().getTime();
            const expiryDate = now + (expiryDays * 24 * 60 * 60 * 1000);
            
            // 保存到公告历史
            const announcementId = generateAnnouncementId();
            announcementsHistory.push({
                id: announcementId,
                title: title || '系統公告',
                content: content,
                priority: priority,
                publishDate: now,
                expiryDate: expiryDate
            });
            saveAnnouncementsToStorage();
            
            // 设置为当前公告
            systemConfig.announcement = {
                title: title || '系統公告',
                content: content,
                priority: priority,
                publishDate: now,
                expiryDate: expiryDate
            };
            
            saveConfigToStorage();
            
            // 创建系统公告消息
            const messageId = generateMessageId();
            const announcementMessage = {
                id: messageId,
                type: 'announcement',
                title: title || '系統公告',
                content: content,
                sender: 'system',
                recipient: 'all',
                timestamp: now,
                read: false,
                threadId: null,
                parentId: null
            };
            
            messages.push(announcementMessage);
            saveMessagesToStorage();
            
            checkAndShowAnnouncement();
            updateCurrentAnnouncementDisplay();
            renderAnnouncementsHistory();
            
            // 清空编辑器
            announcementTitle.value = '系統公告';
            announcementContentEditor.value = '';
            
            showNotification('系統公告已發布', 'success');
        }
        
        // 清除公告
        function clearAnnouncement() {
            if (confirm('確定要清除當前公告嗎？')) {
                systemConfig.announcement = {
                    title: '',
                    content: '',
                    priority: 'medium',
                    publishDate: null,
                    expiryDate: null
                };
                
                saveConfigToStorage();
                checkAndShowAnnouncement();
                updateCurrentAnnouncementDisplay();
                
                showNotification('公告已清除', 'success');
            }
        }
        
        // 预览公告
        function previewAnnouncement() {
            const title = announcementTitle.value.trim() || '系統公告';
            const content = announcementContentEditor.value.trim();
            
            if (!content) {
                showNotification('請輸入公告內容', 'error');
                return;
            }
            
            alert(`公告預覽:\n\n標題: ${title}\n\n內容:\n${content}\n\n點擊"發布公告"按鈕以正式發布。`);
        }
        
        // 检查并显示系统公告
        function checkAndShowAnnouncement() {
            const announcement = systemConfig.announcement;
            
            // 检查是否有公告
            if (!announcement || !announcement.content || announcement.content.trim() === '') {
                announcementSection.style.display = 'none';
                return;
            }
            
            // 检查公告是否过期
            const now = new Date().getTime();
            if (announcement.expiryDate && now > announcement.expiryDate) {
                // 公告已过期，清除
                systemConfig.announcement = {
                    title: '',
                    content: '',
                    priority: 'medium',
                    publishDate: null,
                    expiryDate: null
                };
                saveConfigToStorage();
                announcementSection.style.display = 'none';
                return;
            }
            
            // 显示公告
            const title = announcement.title || '系統公告';
            const content = announcement.content;
            const publishDate = announcement.publishDate ? new Date(announcement.publishDate) : new Date();
            const expiryDate = announcement.expiryDate ? new Date(announcement.expiryDate) : null;
            
            // 更新公告内容
            announcementContent.innerHTML = `<p>${content.replace(/\n/g, '</p><p>')}</p>`;
            announcementDate.innerHTML = `發布時間: ${formatDate(publishDate.getTime())}`;
            
            if (expiryDate) {
                announcementDate.innerHTML += ` | 有效期至: ${formatDate(expiryDate.getTime())}`;
            }
            
            // 根据优先级设置样式
            const priority = announcement.priority || 'medium';
            const announcementCard = document.querySelector('.announcement-card');
            
            // 移除所有优先级类
            announcementCard.classList.remove('announcement-low', 'announcement-medium', 'announcement-high', 'announcement-urgent');
            
            // 添加当前优先级类
            announcementCard.classList.add(`announcement-${priority}`);
            
            // 显示公告区域
            announcementSection.style.display = 'block';
            
            // 更新管理员面板中的当前公告
            updateCurrentAnnouncementDisplay();
        }
        
        // 更新管理员面板中的当前公告显示
        function updateCurrentAnnouncementDisplay() {
            const announcement = systemConfig.announcement;
            
            if (!announcement || !announcement.content || announcement.content.trim() === '') {
                currentAnnouncementTitle.textContent = '無公告';
                currentAnnouncementContent.innerHTML = '<p>目前沒有系統公告。</p>';
                currentAnnouncementDate.textContent = '無';
                currentAnnouncementExpiry.textContent = '無';
                currentAnnouncementPriority.textContent = '中';
                return;
            }
            
            currentAnnouncementTitle.textContent = announcement.title || '系統公告';
            currentAnnouncementContent.innerHTML = `<p>${announcement.content.replace(/\n/g, '</p><p>')}</p>`;
            currentAnnouncementDate.textContent = announcement.publishDate ? formatDate(announcement.publishDate) : '無';
            currentAnnouncementExpiry.textContent = announcement.expiryDate ? formatDate(announcement.expiryDate) : '無';
            currentAnnouncementPriority.textContent = announcement.priority || '中';
        }
        
        // 渲染历史公告列表
        function renderAnnouncementsHistory() {
            announcementsList.innerHTML = '';
            
            if (announcementsHistory.length === 0) {
                announcementsList.innerHTML = '<p>暫無歷史公告</p>';
                return;
            }
            
            // 按发布时间排序（最新的在前面）
            const sortedAnnouncements = [...announcementsHistory].sort((a, b) => b.publishDate - a.publishDate);
            
            sortedAnnouncements.forEach(announcement => {
                const announcementItem = document.createElement('div');
                announcementItem.className = 'announcement-item';
                
                const priorityClass = `priority-${announcement.priority || 'medium'}`;
                const publishDate = formatDate(announcement.publishDate);
                const expiryDate = announcement.expiryDate ? formatDate(announcement.expiryDate) : '無';
                
                announcementItem.innerHTML = `
                    <div class="announcement-priority ${priorityClass}">${announcement.priority || '中'}</div>
                    <h4>${announcement.title || '系統公告'}</h4>
                    <p style="margin: 10px 0; font-size: 0.9rem;">${announcement.content.substring(0, 100)}${announcement.content.length > 100 ? '...' : ''}</p>
                    <div style="font-size: 0.8rem; color: #666;">
                        <div>發布時間: ${publishDate}</div>
                        <div>有效期至: ${expiryDate}</div>
                    </div>
                `;
                
                announcementsList.appendChild(announcementItem);
            });
        }
        
        // 加载系统配置到UI
        function loadConfigToUI() {
            // 积分规则
            configDailyPoints.value = systemConfig.dailyPoints || 10;
            configTaskPoints.value = systemConfig.taskPoints || 50;
            configReadingPoints.value = systemConfig.readingPoints || 30;
            
            // 段位标准
            const tiers = systemConfig.tierThresholds;
            
            const bronze = tiers.find(t => t.name === '青銅');
            const silver = tiers.find(t => t.name === '白銀');
            const gold = tiers.find(t => t.name === '黃金');
            const platinum = tiers.find(t => t.name === '鉑金');
            const diamond = tiers.find(t => t.name === '鑽石');
            const king = tiers.find(t => t.name === '王者');
            
            if (bronze) {
                configBronzeMin.value = bronze.min || 0;
                configBronzeMax.value = bronze.max || 299;
            }
            
            if (silver) {
                configSilverMin.value = silver.min || 300;
                configSilverMax.value = silver.max || 599;
            }
            
            if (gold) {
                configGoldMin.value = gold.min || 600;
                configGoldMax.value = gold.max || 899;
            }
            
            if (platinum) {
                configPlatinumMin.value = platinum.min || 900;
                configPlatinumMax.value = platinum.max || 1199;
            }
            
            if (diamond) {
                configDiamondMin.value = diamond.min || 1200;
                configDiamondMax.value = diamond.max || 1499;
            }
            
            if (king) {
                configKingMin.value = king.min || 1500;
            }
            
            // 等级系统 - 修改为250积分升一级
            configLevelIncrement.value = systemConfig.levelIncrement || 250;
            configMaxLevel.value = systemConfig.maxLevel || 10;
        }
        
        // 保存系统配置
        function saveSystemConfig() {
            // 积分规则
            systemConfig.dailyPoints = parseInt(configDailyPoints.value) || 10;
            systemConfig.taskPoints = parseInt(configTaskPoints.value) || 50;
            systemConfig.readingPoints = parseInt(configReadingPoints.value) || 30;
            
            // 段位标准
            systemConfig.tierThresholds = [
                { name: '青銅', min: parseInt(configBronzeMin.value) || 0, max: parseInt(configBronzeMax.value) || 299, color: 'brown' },
                { name: '白銀', min: parseInt(configSilverMin.value) || 300, max: parseInt(configSilverMax.value) || 599, color: '#5fecfc' },
                { name: '黃金', min: parseInt(configGoldMin.value) || 600, max: parseInt(configGoldMax.value) || 899, color: '#ff8904' },
                { name: '鉑金', min: parseInt(configPlatinumMin.value) || 900, max: parseInt(configPlatinumMax.value) || 1199, color: '#75c8ff' },
                { name: '鑽石', min: parseInt(configDiamondMin.value) || 1200, max: parseInt(configDiamondMax.value) || 1499, color: '#9035F8' },
                { name: '王者', min: parseInt(configKingMin.value) || 1500, max: Infinity, color: '#ffd900' }
            ];
            
            // 等级系统 - 修改为250积分升一级
            systemConfig.levelIncrement = parseInt(configLevelIncrement.value) || 250;
            systemConfig.maxLevel = parseInt(configMaxLevel.value) || 10;
            
            // 保存配置
            saveConfigToStorage();
            
            // 更新所有用户的段位和等级 - 修复等级计算
            users.forEach(user => {
                if (!user.isAdmin) {
                    user.tier = calculateUserTier(user.totalPoints);
                    user.level = calculateUserLevel(user.totalPoints);
                }
            });
            
            saveDataToStorage();
            
            // 更新UI
            renderUsersTable();
            renderUserLeaderboard();
            renderAdminLeaderboard();
            
            // 如果当前用户已登录，更新其显示
            if (currentUser) {
                showUserDashboard();
            }
            
            showNotification('系統參數已保存並生效', 'success');
        }
        
        // 重置系统配置
        function resetSystemConfig() {
            if (confirm('確定要恢復默認系統參數嗎？')) {
                // 恢复默认配置
                systemConfig = {
                    dailyPoints: 10,
                    taskPoints: 50,
                    readingPoints: 30,
                    tierThresholds: [
                        { name: '青銅', min: 0, max: 299, color: 'brown' },
                        { name: '白銀', min: 300, max: 599, color: '#5fecfc' },
                        { name: '黃金', min: 600, max: 899, color: '#ff8904' },
                        { name: '鉑金', min: 900, max: 1199, color: '#75c8ff' },
                        { name: '鑽石', min: 1200, max: 1499, color: '#9035F8' },
                        { name: '王者', min: 1500, max: Infinity, color: '#ffd900' }
                    ],
                    levelIncrement: 250, // 修改为250
                    maxLevel: 10,
                    announcement: systemConfig.announcement, // 保留现有公告
                    notificationPrefs: systemConfig.notificationPrefs // 保留通知偏好
                };
                
                // 重新加载到UI
                loadConfigToUI();
                
                showNotification('系統參數已恢復為默認值', 'success');
            }
        }
        
        // 检查用户成就 - 修复成就检查逻辑，移除积分奖励
        function checkAchievements(user) {
            let newAchievements = [];
            
            // 确保用户有成就数据
            if (!user.achievements) user.achievements = [];
            if (!user.achievementData) user.achievementData = {};
            
            achievements.forEach(achievement => {
                const achievementData = achievement.getData ? achievement.getData(user) : {};
                const isUnlocked = achievement.condition(user, achievementData);
                
                // 检查是否已解锁但未记录
                if (isUnlocked && !user.achievementData[achievement.id]) {
                    // 添加到成就列表
                    if (!user.achievements.includes(achievement.name)) {
                        user.achievements.push(achievement.name);
                        newAchievements.push(achievement);
                    }
                    
                    // 标记为已解锁
                    user.achievementData[achievement.id] = true;
                    
                    // 注意：不再给予积分奖励
                    // 更新成就称号
                    updateUserAchievementTitle(user);
                }
            });
            
            // 如果有新成就，显示通知
            if (newAchievements.length > 0) {
                // 保存数据
                saveDataToStorage();
                
                // 如果当前用户是成就获得者，显示通知
                if (currentUser && currentUser.id === user.id) {
                    // 显示第一个新成就的通知
                    showAchievementNotification(newAchievements[0]);
                    
                    // 如果有多个新成就，稍后显示下一个
                    if (newAchievements.length > 1) {
                        setTimeout(() => {
                            showAchievementNotification(newAchievements[1]);
                        }, 4500);
                    }
                    
                    // 如果用户在成就页面，刷新显示
                    if (document.getElementById('achievements-tab').classList.contains('active')) {
                        renderAchievements();
                        updateAchievementStats();
                    }
                    
                    // 如果用户已登录，更新界面显示
                    if (currentUser && currentUser.id === user.id) {
                        document.getElementById('dashboardUserAchievementTitle').textContent = user.achievementTitle;
                    }
                }
            }
            
            return newAchievements;
        }
        
        // 更新成就统计
        function updateAchievementStats() {
            if (!currentUser) return;
            
            // 确保用户有成就数据
            if (!currentUser.achievements) currentUser.achievements = [];
            if (!currentUser.achievementData) currentUser.achievementData = {};
            
            const unlockedCount = achievements.filter(achievement => {
                const achievementData = achievement.getData ? achievement.getData(currentUser) : {};
                return achievement.condition(currentUser, achievementData);
            }).length;
            
            const totalCount = achievements.length;
            const progressPercentage = totalCount > 0 ? Math.round((unlockedCount / totalCount) * 100) : 0;
            
            document.getElementById('achievementUnlocked').textContent = unlockedCount;
            document.getElementById('achievementTotal').textContent = totalCount;
            document.getElementById('achievementProgress').textContent = `${progressPercentage}%`;
        }
        
        // 显示成就解锁通知
        function showAchievementNotification(achievement) {
            // 检查用户的通知偏好
            if (currentUser && currentUser.notificationPreferences && !currentUser.notificationPreferences.achievementUnlock) {
                return;
            }
            
            achievementNotificationName.textContent = achievement.name;
            achievementNotificationDesc.textContent = achievement.description;
            achievementNotificationReward.textContent = achievement.reward;
            
            // 设置图标
            const iconElement = achievementNotification.querySelector('.achievement-notification-icon i');
            iconElement.className = `fas ${achievement.icon}`;
            
            // 显示通知
            achievementNotification.classList.add('unlocked');
            
            // 播放声音（如果有的话）
            playAchievementSound();
            
            // 4秒后自动隐藏
            if (achievementNotificationTimeout) {
                clearTimeout(achievementNotificationTimeout);
            }
            
            achievementNotificationTimeout = setTimeout(() => {
                achievementNotification.classList.remove('unlocked');
            }, 4000);
        }
        
        // 播放成就解锁声音
        function playAchievementSound() {
            // 这里可以添加音效，如果需要的话
        }
        
        // 更新用户成就称号
        function updateUserAchievementTitle(user) {
            // 检查是否完成了全成就
            const allAchievementsData = achievements.find(a => a.id === 'all_achievements').getData(user);
            const hasAllAchievements = achievements.find(a => a.id === 'all_achievements').condition(user, allAchievementsData);
            
            if (hasAllAchievements) {
                user.achievementTitle = '🏆全成就大師🏆';
            } else {
                // 如果没有全成就，显示最近解锁的成就
                const unlockedAchievements = achievements.filter(achievement => {
                    const achievementData = achievement.getData ? achievement.getData(user) : {};
                    return achievement.condition(user, achievementData);
                });
                
                if (unlockedAchievements.length > 0) {
                    // 取最后一个解锁的成就作为称号
                    const latestAchievement = unlockedAchievements[unlockedAchievements.length - 1];
                    user.achievementTitle = latestAchievement.name;
                } else {
                    user.achievementTitle = '無';
                }
            }
            
            return user.achievementTitle;
        }
        
        // 修复条形码生成函数
        function generateBarcode(code, container) {
            container.innerHTML = '';
            
            if (!code || code.trim() === '') {
                container.innerHTML = '<div class="barcode-placeholder">条形码编码为空</div>';
                return;
            }
            
            try {
                // 创建canvas元素
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                
                // 使用JsBarcode生成条形码
                JsBarcode(canvas, code, {
                    format: "CODE128",
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontOptions: "bold",
                    fontSize: 16,
                    textMargin: 10,
                    margin: 10,
                    background: "#ffffff",
                    lineColor: "#000000"
                });
                
                console.log('QRcode生成成功:', code);
            } catch (error) {
                console.error('QRcode生成失敗:', error);
                container.innerHTML = '<div class="barcode-placeholder">QRcode生成失敗: ' + error.message + '</div>';
            }
        }
        
        // 计算用户段位
        function calculateUserTier(totalPoints) {
            for (const tier of systemConfig.tierThresholds) {
                if (totalPoints >= tier.min && totalPoints <= tier.max) {
                    return tier.name;
                }
            }
            return '青銅';
        }
        
        // 计算用户等级 - 修复为250积分升一级
        function calculateUserLevel(totalPoints) {
            const levelIncrement = systemConfig.levelIncrement || 250; // 修改为250
            const maxLevel = systemConfig.maxLevel || 10;
            
            // 计算等级（从1级开始，每250累积积分升一级）
            const level = Math.floor(totalPoints / levelIncrement) + 1;
            
            // 限制最高等级
            return Math.min(level, maxLevel);
        }
        
        // 获取等级进度
        function getLevelProgress(totalPoints) {
            const levelIncrement = systemConfig.levelIncrement || 250; // 修改为250
            const currentLevel = calculateUserLevel(totalPoints);
            const pointsForCurrentLevel = (currentLevel - 1) * levelIncrement;
            const pointsForNextLevel = currentLevel * levelIncrement;
            const pointsInLevel = totalPoints - pointsForCurrentLevel;
            
            return {
                currentLevel,
                pointsInLevel,
                pointsForNextLevel,
                progressPercentage: Math.min(100, (pointsInLevel / levelIncrement) * 100),
                nextLevelPointsNeeded: pointsForNextLevel - totalPoints
            };
        }
        
        // 获取段位对应的CSS类名
        function getTierClass(tierName) {
            switch(tierName) {
                case '王者': return 'tier-king';
                case '鑽石': return 'tier-diamond';
                case '鉑金': return 'tier-platinum';
                case '黃金': return 'tier-gold';
                case '白銀': return 'tier-silver';
                case '青銅': return 'tier-bronze';
                default: return 'tier-bronze';
            }
        }
        
        // 获取段位对应的颜色
        function getTierColor(tierName) {
            for (const tier of systemConfig.tierThresholds) {
                if (tier.name === tierName) {
                    return tier.color;
                }
            }
            return 'brown';
        }
        
        // 获取等级对应的CSS类名
        function getLevelClass(level) {
            if (level >= 10) return 'level-10';
            if (level >= 9) return 'level-9';
            if (level >= 8) return 'level-8';
            if (level >= 7) return 'level-7';
            if (level >= 6) return 'level-6';
            if (level >= 5) return 'level-5';
            if (level >= 4) return 'level-4';
            if (level >= 3) return 'level-3';
            if (level >= 2) return 'level-2';
            return 'level-1';
        }
        
        // 导出用户数据
        function exportUsersData() {
            const dataStr = JSON.stringify(users.filter(u => !u.isAdmin), null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'users_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('用户數據導出成功', 'success');
        }
        
        // 导出奖品数据
        function exportPrizesData() {
            const dataStr = JSON.stringify(prizes, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'prizes_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('獎品數據導出成功', 'success');
        }
        
        // 导出历史数据
        function exportHistoryData() {
            const dataStr = JSON.stringify(pointsHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'history_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('歷史數據導出成功', 'success');
        }
        
        // 导出所有数据
        function exportAllData() {
            const allData = {
                users: users,
                prizes: prizes,
                history: pointsHistory,
                messages: messages,
                announcements: announcementsHistory,
                config: systemConfig,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'barcode_system_backup.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('系統數據備份成功', 'success');
        }
        
        // 导入数据
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.users && Array.isArray(importedData.users)) {
                        users = importedData.users;
                        
                        // 确保导入的用户数据有累积积分和段位字段
                        users.forEach(user => {
                            if (user.totalPoints === undefined) {
                                user.totalPoints = user.points || 0;
                            }
                            if (user.tier === undefined) {
                                user.tier = calculateUserTier(user.totalPoints);
                            }
                            if (user.level === undefined) {
                                user.level = calculateUserLevel(user.totalPoints);
                            }
                            if (user.achievements === undefined) {
                                user.achievements = [];
                            }
                            if (user.achievementData === undefined) {
                                user.achievementData = {};
                            }
                            if (user.achievementTitle === undefined) {
                                user.achievementTitle = '無';
                            }
                            if (user.lastActive === undefined) {
                                user.lastActive = new Date().getTime();
                            }
                            if (user.notificationPreferences === undefined) {
                                user.notificationPreferences = JSON.parse(JSON.stringify(systemConfig.notificationPrefs));
                            }
                            
                            // 检查成就
                            checkAchievements(user);
                        });
                    }
                    
                    if (importedData.prizes && Array.isArray(importedData.prizes)) {
                        prizes = importedData.prizes;
                    }
                    
                    if (importedData.history && Array.isArray(importedData.history)) {
                        pointsHistory = importedData.history;
                    }
                    
                    if (importedData.messages && Array.isArray(importedData.messages)) {
                        messages = importedData.messages;
                    }
                    
                    if (importedData.announcements && Array.isArray(importedData.announcements)) {
                        announcementsHistory = importedData.announcements;
                    }
                    
                    if (importedData.config) {
                        systemConfig = importedData.config;
                    }
                    
                    saveDataToStorage();
                    saveMessagesToStorage();
                    saveAnnouncementsToStorage();
                    saveConfigToStorage();
                    renderUsersTable();
                    renderPrizesTable();
                    renderPrizes();
                    updateSystemStats();
                    loadConfigToUI();
                    
                    showNotification('數據導入成功', 'success');
                } catch (error) {
                    showNotification('數據導入失败：文件格式錯誤', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // 重置文件输入
            event.target.value = '';
        }
        
        // 修改管理员密码
        function changeAdminPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('請填寫所有密碼字段', 'error');
                return;
            }
            
            if (currentPassword !== adminPassword) {
                showNotification('當前密碼錯誤', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('新密碼和确认密碼不匹配', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('新密码长度至少6位', 'error');
                return;
            }
            
            // 在实际应用中，这里应该将新密码保存到安全的地方
            // 由于这是前端演示，我们无法真正修改硬编码的密码
            // 但可以保存到localStorage作为演示
            localStorage.setItem('adminNewPassword', newPassword);
            
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            showNotification('密码修改需到代碼層尋找*****', 'success');
        }
        
        // 重置系统数据
        function resetSystemData() {
            if (confirm('确定要重置所有系統數據吗？此操作将删除所有用户、獎品和歷史紀錄，且不可恢复！')) {
                users = [
                    { 
                        id: 'ADMIN001', 
                        name: '管理员', 
                        barcodeCode: 'ADMIN001', 
                        points: 0, 
                        totalPoints: 0,
                        tier: '',
                        level: 0,
                        achievementTitle: '無',
                        isAdmin: true,
                        achievements: [],
                        achievementData: {},
                        lastActive: new Date().getTime(),
                        notificationPreferences: JSON.parse(JSON.stringify(systemConfig.notificationPrefs))
                    }
                ];
                prizes = [];
                pointsHistory = [];
                messages = [];
                announcementsHistory = [];
                
                saveDataToStorage();
                saveMessagesToStorage();
                saveAnnouncementsToStorage();
                renderUsersTable();
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                showNotification('系統數據已重置', 'success');
            }
        }
        
        // 生成随机用户ID
        function generateUserId() {
            const prefix = 'U';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机条形码编码
        function generateBarcodeCode() {
            const prefix = 'USER';
            const timestamp = new Date().getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机奖品ID
        function generatePrizeId() {
            const prefix = 'P';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机消息ID
        function generateMessageId() {
            const prefix = 'MSG';
            const timestamp = new Date().getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机对话ID
        function generateThreadId() {
            const prefix = 'THREAD';
            const timestamp = new Date().getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机公告ID
        function generateAnnouncementId() {
            const prefix = 'A';
            const timestamp = new Date().getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 格式化日期
        function formatDate(timestamp) {
            const d = new Date(timestamp);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // 格式化时间差（多久以前）
        function formatTimeAgo(timestamp) {
            const now = new Date().getTime();
            const diff = now - timestamp;
            
            if (diff < 60000) { // 少于1分钟
                return '刚刚';
            } else if (diff < 3600000) { // 少于1小时
                const minutes = Math.floor(diff / 60000);
                return `${minutes}分钟前`;
            } else if (diff < 86400000) { // 少于1天
                const hours = Math.floor(diff / 3600000);
                return `${hours}小时前`;
            } else if (diff < 604800000) { // 少于1周
                const days = Math.floor(diff / 86400000);
                return `${days}天前`;
            } else {
                return formatDate(timestamp);
            }
        }
        
        // 保存数据到本地存储
        function saveDataToStorage() {
            localStorage.setItem('barcodePointsUsers', JSON.stringify(users));
            localStorage.setItem('barcodePointsPrizes', JSON.stringify(prizes));
            localStorage.setItem('barcodePointsHistory', JSON.stringify(pointsHistory));
        }
        
        // 保存消息数据到本地存储
        function saveMessagesToStorage() {
            localStorage.setItem('barcodePointsMessages', JSON.stringify(messages));
        }
        
        // 保存公告历史到本地存储
        function saveAnnouncementsToStorage() {
            localStorage.setItem('barcodePointsAnnouncements', JSON.stringify(announcementsHistory));
        }
        
        // 保存配置到本地存储
        function saveConfigToStorage() {
            localStorage.setItem('barcodePointsConfig', JSON.stringify(systemConfig));
        }
        
        // 显示通知
        function showNotification(message, type) {
            notification.textContent = message;
            notification.style.display = 'block';
            
            if (type === 'success') {
                notification.style.background = '#2ecc71';
            } else if (type === 'error') {
                notification.style.background = '#e74c3c';
            } else {
                notification.style.background = '#3498db';
            }
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // 确保JsBarcode库已加载
        function checkBarcodeLibrary() {
            if (typeof JsBarcode === 'undefined') {
                console.error('JsBarcode library not loaded!');
                return false;
            }
            return true;
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 检查必要的库是否已加载
            if (!checkBarcodeLibrary()) {
                showNotification('QRcode生成庫加載失敗，請刷新頁面重試', 'error');
                return;
            }
            
            initPage();
        });
        
        // 使一些函数在全局可用
        window.selectUser = selectUser;
        window.promoteUser = promoteUser;
        window.demoteUser = demoteUser;
        window.deleteUser = deleteUser;
        window.editPrize = editPrize;
        window.deletePrize = deletePrize;
        window.openRedeemConfirm = openRedeemConfirm;
        window.viewMessageDetail = viewMessageDetail;
        window.markMessageAsRead = markMessageAsRead;
        window.replyToMessage = replyToMessage;
        window.viewAdminMessageDetail = viewAdminMessageDetail;
        window.markAdminMessageAsRead = markAdminMessageAsRead;
        window.deleteMessage = deleteMessage;
    </script>
</body>
</html>